<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë„ìŠ¨íŠ¸ ë§ˆìŠ¤í„° v2.0 â€” ê°•ì˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#08080d;--bg1:#10101a;--bg2:#181828;--bg3:#222238;--bd:#2a2a42;--bd2:#3a3a58;--t1:#eae8f2;--t2:#9a98aa;--t3:#6a6880;--gold:#d4a843;--blue:#5b8def;--green:#4ecb71;--red:#e85d5d;--purple:#a678e8;--cyan:#40c9e0;--orange:#e8934e;--sans:'Noto Sans KR',sans-serif;--serif:'Noto Serif KR',serif;}
*{margin:0;padding:0;box-sizing:border-box;}
html{font-size:14px;scroll-behavior:smooth;}
body{font-family:var(--sans);background:var(--bg0);color:var(--t1);min-height:100vh;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--bg1);}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:3px;}

.app{display:flex;height:100vh;overflow:hidden;}
.side{width:260px;min-width:260px;background:var(--bg1);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow-y:auto;}
.side-hd{padding:18px 14px;border-bottom:1px solid var(--bd);text-align:center;}
.side-hd h1{font-family:var(--serif);font-size:1.15rem;background:linear-gradient(135deg,#d4a843,#e8c874);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.side-hd small{font-size:.65rem;color:var(--t3);display:block;margin-top:4px;}
.nav-sec{padding:10px 0;}
.nav-sec-t{font-size:.6rem;font-weight:700;color:var(--t3);letter-spacing:2px;padding:0 14px;margin-bottom:6px;text-transform:uppercase;}
.nav-i{display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:pointer;font-size:.82rem;color:var(--t2);border-left:3px solid transparent;transition:.2s;}
.nav-i:hover{background:var(--bg2);color:var(--t1);}
.nav-i.on{background:rgba(212,168,67,.08);color:var(--gold);border-left-color:var(--gold);}

.main{flex:1;overflow-y:auto;}
.topbar{position:sticky;top:0;z-index:100;background:rgba(8,8,13,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--bd);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;}
.topbar h2{font-family:var(--serif);font-size:1.05rem;}
.topbar-btn{background:var(--bg2);border:1px solid var(--bd);color:var(--t2);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:.72rem;font-family:var(--sans);transition:.2s;}
.topbar-btn:hover{border-color:var(--gold);color:var(--gold);}

.page{padding:24px;display:none;}
.page.on{display:block;}

.card{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:18px;margin-bottom:18px;}
.card h3{font-family:var(--serif);font-size:.95rem;margin-bottom:12px;}
.badge{font-size:.6rem;padding:3px 8px;border-radius:16px;background:rgba(212,168,67,.13);color:var(--gold);display:inline-block;}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;}

.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
.fg label{font-size:.68rem;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1px;}
.fg input,.fg textarea,.fg select{background:var(--bg0);border:1px solid var(--bd);color:var(--t1);padding:9px 12px;border-radius:6px;font-size:.84rem;font-family:var(--sans);}
.fg input:focus,.fg textarea:focus{outline:none;border-color:var(--gold);}
.fg textarea{min-height:70px;resize:vertical;line-height:1.6;}

.btn{padding:7px 14px;border-radius:6px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);cursor:pointer;font-size:.74rem;font-family:var(--sans);transition:.2s;display:inline-flex;align-items:center;gap:5px;}
.btn:hover{border-color:var(--gold);color:var(--gold);}
.btn-g{background:linear-gradient(135deg,#d4a843,#e8c874);color:#000;border:none;font-weight:700;}
.btn-g:hover{opacity:.9;}
.btn-r{border-color:var(--red);color:var(--red);}
.btn-gr{border-color:var(--green);color:var(--green);}

.chips{display:flex;flex-wrap:wrap;gap:5px;}
.chip{padding:5px 11px;border-radius:18px;font-size:.72rem;border:1px solid var(--bd);cursor:pointer;color:var(--t2);background:var(--bg0);transition:.2s;}
.chip.on{border-color:var(--gold);background:rgba(212,168,67,.13);color:var(--gold);}
.chip:hover{border-color:var(--bd2);}

.tree-box{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;overflow-y:auto;max-height:calc(100vh - 220px);}
.tree-cat{font-size:.62rem;font-weight:700;color:var(--t3);letter-spacing:1px;padding:4px 10px;text-transform:uppercase;}
.tree-i{padding:7px 10px;cursor:pointer;border-radius:6px;font-size:.8rem;display:flex;align-items:center;gap:7px;color:var(--t2);transition:.15s;}
.tree-i:hover{background:var(--bg3);color:var(--t1);}
.tree-i.on{background:rgba(212,168,67,.1);color:var(--gold);}
.tree-ch{padding-left:18px;}

.editor-box{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:18px;overflow-y:auto;max-height:calc(100vh - 220px);}

.sblock{padding:14px;margin-bottom:14px;border-radius:10px;border-left:3px solid var(--gold);background:rgba(212,168,67,.03);}
.sblock.ctx{border-left-color:var(--blue);background:rgba(91,141,239,.03);}
.sblock.art{border-left-color:var(--purple);background:rgba(166,120,232,.03);}
.sblock.formal{border-left-color:var(--cyan);background:rgba(64,201,224,.03);}
.sblock.inter{border-left-color:var(--green);background:rgba(78,203,113,.03);}
.sblock.bridge{border-left-color:var(--orange);background:rgba(232,147,78,.03);}
.sblock.note{border-left-color:var(--red);background:rgba(232,93,93,.04);font-style:italic;font-size:.8rem;}
.sblock-lb{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;display:flex;align-items:center;gap:5px;}
.sblock-tx{font-family:var(--serif);font-size:.9rem;line-height:1.85;}
.time-b{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;background:rgba(212,168,67,.1);border-radius:10px;font-size:.62rem;color:var(--gold);margin-left:8px;}

.stat-row{display:flex;gap:14px;margin-bottom:18px;flex-wrap:wrap;}
.stat-c{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:12px 18px;flex:1;min-width:120px;}
.stat-v{font-size:1.5rem;font-weight:900;}
.stat-l{font-size:.66rem;color:var(--t3);margin-top:2px;}

.artwork-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;}
.art-card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;overflow:hidden;cursor:pointer;transition:.3s;}
.art-card:hover{border-color:var(--gold);transform:translateY(-2px);}
.art-card img{width:100%;height:150px;object-fit:cover;background:var(--bg0);}
.art-card .info{padding:8px;}
.art-card .info .t{font-size:.76rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.art-card .info .a{font-size:.66rem;color:var(--t3);}

.pipe-flow{display:flex;gap:14px;margin-bottom:22px;overflow-x:auto;padding-bottom:8px;}
.pipe-step{min-width:180px;background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;text-align:center;position:relative;}
.pipe-step::after{content:'â†’';position:absolute;right:-12px;top:50%;transform:translateY(-50%);color:var(--t3);font-size:1.1rem;}
.pipe-step:last-child::after{display:none;}
.pipe-num{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#d4a843,#e8c874);color:#000;font-weight:900;font-size:.72rem;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;}
.pipe-t{font-size:.78rem;font-weight:700;}
.pipe-d{font-size:.66rem;color:var(--t3);}

.timer-display{font-size:3.5rem;font-weight:900;color:var(--gold);text-align:center;margin:18px 0;font-variant-numeric:tabular-nums;}
.rh-section{padding:8px 12px;border-radius:6px;margin-bottom:4px;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;background:var(--bg0);border:1px solid var(--bd);}
.rh-section.active{border-color:var(--gold);background:rgba(212,168,67,.08);}
.rh-section.done{opacity:.5;text-decoration:line-through;}

.search-bar{display:flex;gap:8px;margin-bottom:14px;}
.search-bar input{flex:1;background:var(--bg0);border:1px solid var(--bd);color:var(--t1);padding:9px 14px;border-radius:6px;font-size:.84rem;font-family:var(--sans);}
.search-bar input:focus{outline:none;border-color:var(--gold);}

.detail-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:18px;max-height:calc(100vh - 260px);overflow-y:auto;}
.detail-panel img{width:100%;border-radius:10px;margin-bottom:14px;}
.df{margin-bottom:8px;}.df .dl{font-size:.66rem;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1px;}.df .dv{font-size:.84rem;margin-top:2px;}

@media(max-width:900px){
.side{width:52px;min-width:52px;}.side-hd h1,.side-hd small,.nav-sec-t,.nav-i span:not(.ic){display:none;}.nav-i{justify-content:center;padding:10px;}
.grid2,.grid3{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">

<!-- ===== SIDEBAR ===== -->
<nav class="side">
  <div class="side-hd"><h1>ë„ìŠ¨íŠ¸ ë§ˆìŠ¤í„° v2.0</h1><small>Lecture Script Generator â€” Upgraded</small></div>
  <div class="nav-sec">
    <div class="nav-sec-t">1ìˆœìœ„ â€” ë°ì´í„° ê´€ë¦¬</div>
    <div class="nav-i on" onclick="go('p1')"><span class="ic">ğŸ“</span><span>ë°ì´í„° ë§¤ë‹ˆì €</span></div>
    <div class="nav-i" onclick="go('p2')"><span class="ic">ğŸ“¥</span><span>JSON ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°</span></div>
  </div>
  <div class="nav-sec">
    <div class="nav-sec-t">2ìˆœìœ„ â€” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±</div>
    <div class="nav-i" onclick="go('p3')"><span class="ic">ğŸ“</span><span>í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸°</span></div>
  </div>
  <div class="nav-sec">
    <div class="nav-sec-t">3ìˆœìœ„ â€” ì˜¤í”ˆ API</div>
    <div class="nav-i" onclick="go('p4')"><span class="ic">ğŸ›ï¸</span><span>ë©”íŠ¸ë¡œí´ë¦¬íƒ„ ë¯¸ìˆ ê´€</span></div>
  </div>
  <div class="nav-sec">
    <div class="nav-sec-t">4ìˆœìœ„ â€” AI íŒŒì´í”„ë¼ì¸</div>
    <div class="nav-i" onclick="go('p5')"><span class="ic">ğŸ¤–</span><span>AI ìŠ¤í¬ë¦½íŠ¸ ìƒì„±</span></div>
  </div>
  <div class="nav-sec">
    <div class="nav-sec-t">ë„êµ¬</div>
    <div class="nav-i" onclick="go('p6')"><span class="ic">â±ï¸</span><span>ë¦¬í—ˆì„¤ íƒ€ì´ë¨¸</span></div>
    <div class="nav-i" onclick="go('p7')"><span class="ic">ğŸ“¤</span><span>ë‚´ë³´ë‚´ê¸°</span></div>
  </div>
</nav>

<!-- ===== MAIN ===== -->
<main class="main">
<div class="topbar">
  <h2 id="ptitle">ğŸ“ ë°ì´í„° ë§¤ë‹ˆì €</h2>
<div style="display:flex;gap:6px;">
    <button class="topbar-btn" onclick="dlAll()">ğŸ’¾ ì „ì²´ ë°±ì—…</button>
    <button class="topbar-btn" onclick="showScriptManager()">ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ê´€ë¦¬</button>
    <button class="topbar-btn" onclick="resetAll()">ğŸ”„ ì´ˆê¸°í™”</button>
</div>
</div>

<!-- ====== PAGE 1: DATA MANAGER ====== -->
<div class="page on" id="p1">
  <div class="stat-row">
    <div class="stat-c"><div class="stat-v" style="color:var(--gold)" id="s-mod">0</div><div class="stat-l">ì „ì²´ ëª¨ë“ˆ</div></div>
    <div class="stat-c"><div class="stat-v" style="color:var(--blue)" id="s-art">0</div><div class="stat-l">ë“±ë¡ ì‘í’ˆ</div></div>
<div class="stat-c" onclick="showScriptManager()" style="cursor:pointer;" title="í´ë¦­í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ê´€ë¦¬">
  <div class="stat-v" style="color:var(--green)" id="s-scr">0</div>
  <div class="stat-l">ìƒì„± ìŠ¤í¬ë¦½íŠ¸ âœï¸</div>
</div>
    <div class="stat-c"><div class="stat-v" style="color:var(--purple)" id="s-ver">0</div><div class="stat-l">ê²€ì¦ ì™„ë£Œ</div></div>
  </div>
  <div style="display:grid;grid-template-columns:260px 1fr;gap:18px;">
    <div class="tree-box" id="tree"></div>
    <div class="editor-box" id="editor"><p style="color:var(--t3);text-align:center;padding:40px;">â† ì¢Œì¸¡ íŠ¸ë¦¬ì—ì„œ ëª¨ë“ˆ ë˜ëŠ” ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”</p></div>
  </div>
</div>

<!-- ====== PAGE 2: JSON IMPORT/EXPORT ====== -->
<div class="page" id="p2">
  <div class="grid2">
    <div class="card">
      <h3>ğŸ“¥ JSON ê°€ì ¸ì˜¤ê¸°</h3>
      <div class="fg"><label>JSON íŒŒì¼ ì—…ë¡œë“œ</label><input type="file" accept=".json" id="jfile" onchange="jImport(event)"></div>
      <div class="fg"><label>ë˜ëŠ” JSON ì§ì ‘ ë¶™ì—¬ë„£ê¸°</label><textarea id="jpaste" rows="10" placeholder='{"modules":[...]}'></textarea></div>
      <div style="display:flex;gap:6px;"><button class="btn btn-g" onclick="jPaste()">ë¶™ì—¬ë„£ê¸°ì—ì„œ ê°€ì ¸ì˜¤ê¸°</button><button class="btn" onclick="jMerge()">ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©</button></div>
    </div>
    <div class="card">
      <h3>ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°</h3>
      <div class="fg"><label>ë²”ìœ„</label><select id="escope"><option value="all">ì „ì²´</option><option value="western">ì„œì–‘ë¯¸ìˆ ì‚¬</option><option value="eastern">ë™ì–‘ë¯¸ìˆ ì‚¬</option><option value="exhibition">ì „ì‹œê¸°íš</option></select></div>
      <div style="display:flex;gap:6px;margin-top:8px;"><button class="btn btn-g" onclick="jExport()">ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ</button><button class="btn" onclick="jCopy()">ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬</button></div>
      <div class="fg" style="margin-top:12px;"><label>ë¯¸ë¦¬ë³´ê¸°</label><textarea id="jprev" rows="10" readonly style="font-family:monospace;font-size:.72rem;"></textarea></div>
    </div>
  </div>
</div>

<!-- ====== PAGE 3: SCRIPT GENERATOR ====== -->
<div class="page" id="p3">
  <div style="display:grid;grid-template-columns:300px 1fr;gap:18px;">
    <div style="background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:18px;overflow-y:auto;max-height:calc(100vh - 160px);">
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ëª¨ë“ˆ ì„ íƒ</div>
        <select id="selmod" style="width:100%;padding:9px;background:var(--bg0);border:1px solid var(--bd);color:var(--t1);border-radius:6px;" onchange="onModSel()"></select>
        <div id="artlist" style="margin-top:10px;"></div>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ìŠ¤í¬ë¦½íŠ¸ ìœ í˜•</div>
        <div class="chips" id="ch-type"><div class="chip on" data-v="docent">ë„ìŠ¨íŠ¸ í•´ì„¤</div><div class="chip" data-v="lecture">ê°•ì˜</div><div class="chip" data-v="planning">ê¸°íš ë°œí‘œ</div></div>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ì‹œê°„ (ë¶„)</div>
        <input type="range" id="dur" min="10" max="120" value="40" style="width:100%;" oninput="document.getElementById('durv').textContent=this.value+'ë¶„'">
<span id="durv" style="font-size:.78rem;color:var(--gold);">40ë¶„</span>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ğŸ“„ ëª©í‘œ ë¶„ëŸ‰ (A4 ì¥ìˆ˜)</div>
        <div class="chips" id="ch-pages">
          <div class="chip" data-v="2" onclick="document.getElementById('target-pages').value='2';document.querySelectorAll('#ch-pages .chip').forEach(c=>c.classList.remove('on'));this.classList.add('on');">2ì¥</div>
          <div class="chip on" data-v="4" onclick="document.getElementById('target-pages').value='4';document.querySelectorAll('#ch-pages .chip').forEach(c=>c.classList.remove('on'));this.classList.add('on');">4ì¥</div>
          <div class="chip" data-v="6" onclick="document.getElementById('target-pages').value='6';document.querySelectorAll('#ch-pages .chip').forEach(c=>c.classList.remove('on'));this.classList.add('on');">6ì¥</div>
          <div class="chip" data-v="8" onclick="document.getElementById('target-pages').value='8';document.querySelectorAll('#ch-pages .chip').forEach(c=>c.classList.remove('on'));this.classList.add('on');">8ì¥</div>
          <div class="chip" data-v="10" onclick="document.getElementById('target-pages').value='10';document.querySelectorAll('#ch-pages .chip').forEach(c=>c.classList.remove('on'));this.classList.add('on');">10ì¥</div>
        </div>
        <input type="hidden" id="target-pages" value="4">
        <div style="font-size:.65rem;color:var(--t3);margin-top:4px;">1ì¥ â‰ˆ 1,500ì (11pt ê¸°ì¤€) | 4ì¥ = ì•½ 20ë¶„ ë°œí™”ëŸ‰</div>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ëŒ€ìƒ</div>

        <div class="chips" id="ch-aud"><div class="chip" data-v="beginner">ì´ˆë³´</div><div class="chip on" data-v="intermediate">ì¤‘ê¸‰</div><div class="chip" data-v="expert">ì „ë¬¸ê°€</div></div>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">ì–´ì¡°</div>
        <div class="chips" id="ch-tone"><div class="chip on" data-v="professional">ì „ë¬¸ì </div><div class="chip" data-v="warm">ë”°ëœ»í•œ</div><div class="chip" data-v="story">ìŠ¤í† ë¦¬í…”ë§</div></div>
      </div>
      <div style="margin-bottom:16px;"><div style="font-size:.68rem;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px;">í¬í•¨ ìš”ì†Œ</div>
        <div class="chips" id="ch-el">
          <div class="chip on" data-v="opening">ì˜¤í”„ë‹</div><div class="chip on" data-v="context">ì‹œëŒ€ë§¥ë½</div>
          <div class="chip on" data-v="formal">í˜•ì‹ë¶„ì„</div><div class="chip on" data-v="artwork">ì‘í’ˆí•´ì„¤</div>
          <div class="chip on" data-v="comparative">ë¹„êµì‘í’ˆ</div><div class="chip on" data-v="interactive">ê´€ëŒê°ì§ˆë¬¸</div>
          <div class="chip on" data-v="bridge">ì „í™˜ë©˜íŠ¸</div><div class="chip" data-v="note">ë„ìŠ¨íŠ¸ë…¸íŠ¸</div>
          <div class="chip on" data-v="closing">í´ë¡œì§•</div><div class="chip" data-v="refs">ì°¸ê³ ë¬¸í—Œ</div>
        </div>
      </div>
      <button class="btn btn-g" style="width:100%;padding:13px;" onclick="genScript()">âœ¨ í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±</button>
    </div>
    <div id="sout" style="background:var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:22px;overflow-y:auto;max-height:calc(100vh - 160px);">
      <p style="color:var(--t3);text-align:center;padding:50px;">ëª¨ë“ˆê³¼ ì˜µì…˜ ì„ íƒ í›„ <strong style="color:var(--gold);">"í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"</strong> í´ë¦­</p>
    </div>
  </div>
</div>

<!-- ====== PAGE 4: MET API ====== -->
<div class="page" id="p4">
  <div class="card">
    <h3>ğŸ›ï¸ The Metropolitan Museum of Art â€” Open Access API <span class="badge">47ë§Œ+ ì‘í’ˆ Â· APIí‚¤ ë¶ˆí•„ìš”</span></h3>
    <div class="search-bar">
      <input id="met-q" placeholder="ì‘í’ˆëª…Â·ì‘ê°€ëª… ê²€ìƒ‰ (ì˜ë¬¸)... ì˜ˆ: Monet, Sunflowers" onkeypress="if(event.key==='Enter')metSearch()">
      <button class="btn btn-g" onclick="metSearch()">ğŸ” ê²€ìƒ‰</button>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
      <select id="met-dept" style="background:var(--bg0);border:1px solid var(--bd);color:var(--t2);padding:5px 10px;border-radius:6px;font-size:.72rem;">
        <option value="">ì „ì²´ ë¶€ì„œ</option><option value="11">European Paintings</option><option value="21">Modern Art</option>
        <option value="6">Asian Art</option><option value="13">Greek & Roman</option><option value="10">Egyptian</option>
      </select>
      <select id="met-hl" style="background:var(--bg0);border:1px solid var(--bd);color:var(--t2);padding:5px 10px;border-radius:6px;font-size:.72rem;">
        <option value="">ì „ì²´</option><option value="true">í•˜ì´ë¼ì´íŠ¸ë§Œ</option>
      </select>
    </div>
    <div id="met-status" style="font-size:.72rem;color:var(--t3);">ê²€ìƒ‰ ì¤€ë¹„ ì™„ë£Œ</div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
    <div><div id="met-cnt" style="font-size:.72rem;color:var(--t3);margin-bottom:10px;"></div><div class="artwork-grid" id="met-grid"><p style="color:var(--t3);text-align:center;grid-column:1/-1;padding:30px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p></div></div>
    <div class="detail-panel" id="met-detail"><p style="color:var(--t3);text-align:center;padding:30px;">ì‘í’ˆì„ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ í‘œì‹œ</p></div>
  </div>
</div>

<!-- ====== PAGE 5: AI PIPELINE ====== -->
<div class="page" id="p5">
  <div class="pipe-flow">
    <div class="pipe-step"><div class="pipe-num">1</div><div class="pipe-t">ë°ì´í„° ì„ íƒ</div><div class="pipe-d">ëª¨ë“ˆÂ·ì‘í’ˆ ì„ íƒ</div></div>
    <div class="pipe-step"><div class="pipe-num">2</div><div class="pipe-t">í”„ë¡¬í”„íŠ¸ ìƒì„±</div><div class="pipe-d">ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ êµ¬ì„±</div></div>
    <div class="pipe-step"><div class="pipe-num">3</div><div class="pipe-t">AI ì´ˆì•ˆ ìƒì„±</div><div class="pipe-d">Claude API í˜¸ì¶œ</div></div>
    <div class="pipe-step"><div class="pipe-num">4</div><div class="pipe-t">ê²€ì¦ & ì €ì¥</div><div class="pipe-d">íë ˆì´í„° ê²€ìˆ˜ í›„ ì €ì¥</div></div>
  </div>
  <div class="grid2">
    <div class="card">
      <h3>ğŸ”‘ API ì„¤ì • & í”„ë¡¬í”„íŠ¸</h3>
      <div class="fg"><label>Anthropic API Key</label><input type="password" id="aikey" placeholder="sk-ant-..."></div>
      <div class="fg"><label>ëŒ€ìƒ ëª¨ë“ˆ</label><select id="aimod" style="width:100%;padding:9px;background:var(--bg0);border:1px solid var(--bd);color:var(--t1);border-radius:6px;"></select></div>
      <div class="fg"><label>ì¶”ê°€ ì§€ì‹œì‚¬í•­</label><textarea id="aiinst" rows="3" placeholder="ì˜ˆ: 20ëŒ€ ëŒ€ìƒ, ì¹œê·¼í•œ ì–´ì¡°, ë¹„êµì‘í’ˆ 2ê°œ ì´ìƒ..."></textarea></div>
      <div class="fg"><label>ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ (í¸ì§‘ ê°€ëŠ¥)</label><textarea id="aiprompt" rows="8" style="font-size:.72rem;"></textarea></div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-g" onclick="buildPrompt()">ğŸ“ í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
        <button class="btn btn-g" onclick="callAI()">ğŸ¤– AI í˜¸ì¶œ</button>
      </div>
      <div id="ai-status" style="font-size:.72rem;color:var(--t3);margin-top:8px;">ëŒ€ê¸° ì¤‘</div>
    </div>
    <div class="card">
      <h3>ğŸ“„ AI ìƒì„± ê²°ê³¼</h3>
      <div style="display:flex;gap:6px;margin-bottom:10px;">
        <button class="btn btn-gr" onclick="verifyAI()">âœ… ê²€ì¦ ì™„ë£Œ í‘œì‹œ</button>
        <button class="btn" onclick="copyAI()">ğŸ“‹ ë³µì‚¬</button>
        <button class="btn" onclick="saveAItoModule()">ğŸ’¾ ëª¨ë“ˆì— ì €ì¥</button>
      </div>
      <div id="aiout" contenteditable="true" style="background:var(--bg0);border:1px solid var(--bd);border-radius:10px;padding:14px;min-height:300px;max-height:500px;overflow-y:auto;font-family:var(--serif);font-size:.86rem;line-height:1.8;white-space:pre-wrap;">AI ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ìƒì„± í›„ ì§ì ‘ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

<!-- ====== PAGE 6: REHEARSAL ====== -->
<div class="page" id="p6">
  <div class="card" style="max-width:650px;margin:0 auto;text-align:center;">
    <h3>â±ï¸ ë¦¬í—ˆì„¤ íƒ€ì´ë¨¸</h3>
    <div class="timer-display" id="rh-time">00:00</div>
    <div id="rh-sec-name" style="font-size:.9rem;color:var(--t2);margin-bottom:16px;">ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”</div>
    <div style="display:flex;gap:10px;justify-content:center;margin-bottom:18px;">
      <button class="btn btn-g" onclick="rhStart()">â–¶ ì‹œì‘</button>
      <button class="btn" onclick="rhPause()">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn" onclick="rhNext()">â­ ë‹¤ìŒ</button>
      <button class="btn btn-r" onclick="rhReset()">â¹ ì´ˆê¸°í™”</button>
    </div>
    <div id="rh-list" style="text-align:left;"></div>
  </div>
</div>

<!-- ====== PAGE 7: EXPORT ====== -->
<div class="page" id="p7">
  <div class="grid2">
    <div class="card">
      <h3>ğŸ“„ TXT / Markdown ë‚´ë³´ë‚´ê¸°</h3>
      <p style="font-size:.8rem;color:var(--t2);margin-bottom:12px;">ë§ˆì§€ë§‰ìœ¼ë¡œ ìƒì„±í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
      <div style="display:flex;gap:6px;"><button class="btn btn-g" onclick="expTxt()">ğŸ“¥ TXT ë‹¤ìš´ë¡œë“œ</button><button class="btn" onclick="expClip()">ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬</button></div>
    </div>
    <div class="card">
      <h3>ğŸ–¨ï¸ ì¸ì‡„ìš© (ë¸Œë¼ìš°ì € ì¸ì‡„)</h3>
      <p style="font-size:.8rem;color:var(--t2);margin-bottom:12px;">Ctrl+Pë¡œ PDF ì €ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      <button class="btn btn-g" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
    </div>
  </div>
</div>

</main>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LAYER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEF={version:"2.0",lastUpdated:"2026-02-22",modules:[
{id:"W01",category:"western",title:"ì„ ì‚¬ì‹œëŒ€ & ê³ ëŒ€ ê·¼ë™ ë¯¸ìˆ ",period:"BC 30,000 ~ BC 332",hours:8,weekNumber:1,
coreQuestion:"ì¸ë¥˜ëŠ” ì™œ ê·¸ë¦¼ì„ ê·¸ë¦¬ê¸° ì‹œì‘í–ˆëŠ”ê°€?",
concepts:["ì£¼ìˆ ì  ê¸°ëŠ¥ì„¤","ë¹„ë„ˆìŠ¤ ìƒì˜ í’ìš” ìƒì§•","ë©”ê°ˆë¦¬ìŠ¤ ë¬¸í™”","ë™êµ´ ë²½í™”ì˜ ì‚¬íšŒì  ê¸°ëŠ¥"],
references:["Gombrich Ch.1 'Strange Beginnings'","Janson Ch.1","ì§„ì¤‘ê¶Œ ã€ì„œì–‘ë¯¸ìˆ ì‚¬: ê³ ì „ì˜ˆìˆ í¸ã€ 1ì¥"],
bridgeText:"ë™êµ´ì˜ ì–´ë‘  ì†ì—ì„œ ì‹œì‘ëœ ì‹œê° í‘œí˜„ì€ ë„ì‹œ ë¬¸ëª…ê³¼ í•¨ê»˜ ìƒˆë¡œìš´ ë‹¨ê³„ë¡œ ë‚˜ì•„ê°‘ë‹ˆë‹¤.",
artworks:[
{id:"W01-A01",title:"ë¼ìŠ¤ì½” ë™êµ´ë²½í™”",artist:"ì‘ì ë¯¸ìƒ",year:"BC 17,000ê²½",medium:"ë™êµ´ ë²½ë©´ì— ì²œì—° ì•ˆë£Œ",dimensions:"ëŒ€í˜• í™€ ì•½ 20m",location:"í”„ë‘ìŠ¤ ë„ë¥´ë„ë‰´",museum:"ë¼ìŠ¤ì½” IV ì„¼í„° (ë³µì œ)",imageUrl:"",
formalAnalysis:{composition:"ìˆ˜í‰ êµ¬ë„, ë™ë¬¼ í–‰ë ¬ì´ ì¢Œâ†’ìš° ì´ë™í•˜ëŠ” ìš´ë™ê°",color:"í™©í† ìƒ‰Â·ì ê°ˆìƒ‰Â·ê²€ì •ì˜ ì œí•œëœ íŒ”ë ˆíŠ¸ë¡œ ë†ë„ ì¡°ì ˆí•˜ì—¬ ì…ì²´ê° êµ¬í˜„",brushwork:"ì†ê°€ë½ ë„í¬, ê°ˆëŒ€ ë¶“, ì…ìœ¼ë¡œ ë¶„ì‚¬í•˜ëŠ” ì—ì–´ë¸ŒëŸ¬ì‹œ ê¸°ë²•",gazeGuide:"ëŒ€í˜• í™€ ì…êµ¬ì—ì„œ ì‹œê³„ë°©í–¥: ì˜¤ë¡œí¬ì†Œ â†’ ì‚¬ìŠ´ í–‰ë ¬ â†’ ë§ â†’ ìš°ë¬¼ ì¥ë©´"},
historicalContext:"êµ¬ì„ê¸° í›„ê¸°(ë§ˆë“¤ë Œ ë¬¸í™”ê¸°), ë¹™í•˜ê¸° ë§ê¸°. ìˆ˜ë µì±„ì§‘ ì‚¬íšŒì—ì„œ ë™ë¬¼ì€ ì‹ëŸ‰ì´ì ì˜ì  ëŒ€ìƒ. ì‚¬ëƒ¥ ê¸°ì› ì£¼ìˆ , ê³„ì ˆ ê¸°ë¡ ë‹¬ë ¥, ì„±ë…„ì‹ ê³µê°„ ì¥ì‹ ë“± ë‹¤ì–‘í•œ í•´ì„ì´ ê³µì¡´í•©ë‹ˆë‹¤.",
comparativeWorks:["ì•Œíƒ€ë¯¸ë¼ ë™êµ´ë²½í™” (ìŠ¤í˜ì¸, BC 15,000ê²½)","ì‡¼ë²  ë™êµ´ë²½í™” (í”„ë‘ìŠ¤, BC 32,000ê²½)","ì¸ë„ë„¤ì‹œì•„ ìˆ ë¼ì›¨ì‹œ ë™êµ´ë²½í™” (BC 45,500ê²½)"],
interactiveQuestion:"íšƒë¶ˆ í•˜ë‚˜ ë“¤ê³  ì´ ë™êµ´ì— ë“¤ì–´ì™”ë‹¤ ìƒìƒí•´ ë³´ì„¸ìš”. í”ë“¤ë¦¬ëŠ” ë¶ˆë¹› ì•„ë˜ ì†Œë“¤ì´ ì›€ì§ì´ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ ì•Šì„ê¹Œìš”?",
speakerNote:"â± 5ë¶„ | ì²œì¥ ê³¡ë©´ ì‚¬ì§„ ê°€ë¦¬í‚¤ë©° 3D í‘œí˜„ ê°•ì¡°. ê´€ê°ì—ê²Œ ëˆˆ ë°˜ì¯¤ ê°ë„ë¡ ìœ ë„.",verified:true,lastModified:"2026-02-22"},
{id:"W01-A02",title:"ë¹Œë Œë„ë¥´í”„ì˜ ë¹„ë„ˆìŠ¤",artist:"ì‘ì ë¯¸ìƒ",year:"BC 25,000ê²½",medium:"ì„íšŒì•” ì¡°ê°",dimensions:"ë†’ì´ 11.1cm",location:"ì˜¤ìŠ¤íŠ¸ë¦¬ì•„",museum:"ë¹ˆ ìì—°ì‚¬ ë°•ë¬¼ê´€",imageUrl:"",
formalAnalysis:{composition:"ì •ë©´ì„±, ì¢Œìš° ëŒ€ì¹­. ê°€ìŠ´Â·ë°°Â·ì—‰ë©ì´ ê·¹ë‹¨ì  ê³¼ì¥, ì–¼êµ´ ìƒëµ",color:"ì›ë˜ ì ìƒ‰ ì•ˆë£Œ(ì˜¤ì»¤) í”ì  â€” ìƒëª…ë ¥Â·ë‹¤ì‚° ìƒì§•",brushwork:"ì†ë°”ë‹¥ ì•ˆ í¬ê¸°(11.1cm). ë¶€ì‹¯ëŒë¡œ ì„¸ë°€ ì¡°ê° í›„ ì—°ë§ˆ",gazeGuide:"ì •ë©´ ì‹¤ë£¨ì—£ â†’ ê³¼ì¥ëœ ì‹ ì²´ í´ë¡œì¦ˆì—… â†’ ë’·ë©´ ê¼° ë¨¸ë¦¬ì¹´ë½ ë””í…Œì¼"},
historicalContext:"êµ¬ì„ê¸° í›„ê¸° ê·¸ë¼ë² íŠ¸ ë¬¸í™”. ìœ ëŸ½ ì „ì—­ì—ì„œ ìœ ì‚¬ ë¹„ë„ˆìŠ¤ ìƒ 200ì—¬ ì  ë°œê²¬. ë‹¤ì‚° ìƒì§•, ì–´ë¨¸ë‹ˆì‹  ìˆ­ë°°, ì—¬ì„± ìí™”ìƒ ë“± ë‹¤ì–‘í•œ í•´ì„ ê³µì¡´.",
comparativeWorks:["ë ˆìŠ¤í“Œê·¸ì˜ ë¹„ë„ˆìŠ¤ (í”„ë‘ìŠ¤, BC 23,000ê²½)","í˜¸í˜ë ˆ í ìŠ¤ì˜ ë¹„ë„ˆìŠ¤ (ë…ì¼, BC 35,000ê²½)"],
interactiveQuestion:"í•œ ì†ì— ì™ ë“¤ì–´ì˜¤ëŠ” ì´ ì¡°ê°ìƒì„ 3ë§Œ ë…„ ì „ ëˆ„êµ°ê°€ê°€ ì†ì— ì¥ê³  ë¬´ì—‡ì„ ë¹Œì—ˆì„ê¹Œìš”?",
speakerNote:"â± 4ë¶„ | 3D í”„ë¦°íŠ¸ ë³µì œí’ˆ ê´€ê°ì—ê²Œ ëŒë ¤ë³´ê²Œ í•˜ë©´ íš¨ê³¼ì . 'ë¹„ë„ˆìŠ¤'ëŠ” ê·¼ëŒ€ í•™ì ëª…ëª…ì„ì„ ì–¸ê¸‰.",verified:true,lastModified:"2026-02-22"},
{id:"W01-A03",title:"ìŠ¤í†¤í—¨ì§€",artist:"ì‘ì ë¯¸ìƒ",year:"BC 3,000~2,000ê²½",medium:"ì‚¬ë¥´ì„¼(ì‚¬ì•”) + ë¸”ë£¨ìŠ¤í†¤(í˜„ë¬´ì•”)",dimensions:"ì™¸ê³½ ì›í˜• ì§€ë¦„ 33m, ìµœëŒ€ ë†’ì´ 7.3m",location:"ì˜êµ­ ìœŒíŠ¸ì…”",museum:"í˜„ì§€ (English Heritage)",imageUrl:"",
formalAnalysis:{composition:"ë™ì‹¬ì› ë°°ì¹˜. í•˜ì§€ ì¼ì¶œ ì¶•ì„ ê³¼ ì •í™•íˆ ì •ë ¬",color:"ì‚¬ë¥´ì„¼ íšŒë°±ìƒ‰ê³¼ ë¸”ë£¨ìŠ¤í†¤ ì²­ë¡ìƒ‰ ëŒ€ë¹„",brushwork:"ì¸í…Â·ëª¨ë¥´í‹°ìŠ¤Â·í…Œë„Œ ê²°í•© ê¸°ë²•. 240km ë–¨ì–´ì§„ ì›¨ì¼ìŠ¤ì—ì„œ ìš´ë°˜",gazeGuide:"ë¹„ì§€í„° ì„¼í„°ì—ì„œ ì ‘ê·¼ ì‹œ ì „ì²´ ìŠ¤ì¹´ì´ë¼ì¸ â†’ íŠ¸ë¦´ë¦¬í†¤ í´ë¡œì¦ˆì—… â†’ íìŠ¤í†¤"},
historicalContext:"ì•½ 1,500ë…„ì— ê±¸ì³ ë‹¤ë‹¨ê³„ ê±´ì„¤. ì²œë¬¸ ê´€ì¸¡ì†Œ, ì¹˜ìœ  ì„±ì§€, ì¡°ìƒ ìˆ­ë°° ì¥ì†Œ ë“± í•´ì„ ë‹¤ì–‘.",
comparativeWorks:["ì¹´ë¥´ë‚™ ì—´ì„ (í”„ë‘ìŠ¤, BC 4,500ê²½)","ë‰´ê·¸ë ˆì¸ì§€ (ì•„ì¼ëœë“œ, BC 3,200ê²½)","ê´´ë² í´ë¦¬ í…Œí˜ (íŠ€ë¥´í‚¤ì˜ˆ, BC 9,500ê²½)"],
interactiveQuestion:"25í†¤ ëŒì„ 240kmë‚˜ ìš´ë°˜í•œ ì‚¬ëŒë“¤ì€ ì–´ë–¤ ë¯¿ìŒì´ ìˆì—ˆê¸°ì— ì´ëŸ° ì¼ì„ í•´ë‚¼ ìˆ˜ ìˆì—ˆì„ê¹Œìš”?",
speakerNote:"â± 4ë¶„ | í•˜ì§€ ì¼ì¶œ ë‹¤ì´ì–´ê·¸ë¨ í•„ìˆ˜. í•œêµ­ ê³ ì¸ëŒê³¼ ë¹„êµí•˜ë©´ ë™ì„œì–‘ ì—°ê²° íš¨ê³¼.",verified:true,lastModified:"2026-02-22"}
]},
{id:"W02",category:"western",title:"ê·¸ë¦¬ìŠ¤Â·ë¡œë§ˆ ë¯¸ìˆ ",period:"BC 800 ~ AD 476",hours:8,weekNumber:2,
coreQuestion:"ì™œ ê·¸ë¦¬ìŠ¤ì¸ë“¤ì€ 'ì´ìƒì  ì¸ì²´'ì— ì§‘ì°©í–ˆëŠ”ê°€?",
concepts:["ì½˜íŠ¸ë¼í¬ìŠ¤í† ","ê³ ì „ê¸° ì´ìƒì£¼ì˜","í—¬ë ˆë‹ˆì¦˜ ê°ì • í‘œí˜„","ë¡œë§ˆ ì‚¬ì‹¤ì£¼ì˜(Verism)"],
references:["Gombrich Ch.3-4","Janson Ch.5-7"],bridgeText:"ê·¸ë¦¬ìŠ¤ê°€ ì„¸ìš´ ë¯¸ì˜ ì´ìƒì€ ë¡œë§ˆë¥¼ ê±°ì³ 1,000ë…„ í›„ ë¥´ë„¤ìƒìŠ¤ì—ì„œ ë¶€í™œí•©ë‹ˆë‹¤.",artworks:[]},
{id:"W03",category:"western",title:"ì¤‘ì„¸ ë¯¸ìˆ ",period:"AD 476 ~ 1400",hours:8,weekNumber:3,
coreQuestion:"ì¤‘ì„¸ëŠ” ì •ë§ 'ì•”í‘ì‹œëŒ€'ì˜€ëŠ”ê°€?",
concepts:["ë¹„ì”í‹´ ì´ì½˜","ê³ ë”• ëŒ€ì„±ë‹¹","ìŠ¤í…Œì¸ë“œê¸€ë¼ìŠ¤ì˜ ë¹›ì˜ ì‹ í•™"],
references:["Gombrich Ch.6-9"],bridgeText:"ê³ ë”• ì²¨íƒ‘ì˜ ì—´ë§ì€ ë¥´ë„¤ìƒìŠ¤ì˜ ì„œë§‰ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.",artworks:[]},
{id:"W04",category:"western",title:"ë¥´ë„¤ìƒìŠ¤ & ë§¤ë„ˆë¦¬ì¦˜",period:"1400 ~ 1600",hours:8,weekNumber:4,
coreQuestion:"ë¥´ë„¤ìƒìŠ¤ëŠ” ì™œ í”¼ë Œì²´ì—ì„œ ì‹œì‘ë˜ì—ˆëŠ”ê°€?",
concepts:["ì„ í˜• ì›ê·¼ë²•","ì¸ë¬¸ì£¼ì˜","ìŠ¤í‘¸ë§ˆí† Â·í‚¤ì•„ë¡œìŠ¤ì¿ ë¡œ"],
references:["Gombrich Ch.12-16","Vasari ã€ì˜ˆìˆ ê°€ ì—´ì „ã€"],bridgeText:"ì™„ë²½í•œ ê· í˜•ì´ ê¹¨ì§€ë©° ë°”ë¡œí¬ì˜ ë“œë¼ë§ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.",artworks:[]},
{id:"W05",category:"western",title:"ë°”ë¡œí¬Â·ë¡œì½”ì½” ~ ì¸ìƒì£¼ì˜ ~ í˜„ëŒ€",period:"1600 ~ í˜„ì¬",hours:16,weekNumber:5,
coreQuestion:"ë¯¸ìˆ ì€ ì™œ 'ë³´ì´ëŠ” ê²ƒ'ì—ì„œ 'ë³´ì´ì§€ ì•ŠëŠ” ê²ƒ'ìœ¼ë¡œ í–¥í–ˆëŠ”ê°€?",
concepts:["í…Œë„¤ë¸Œë¦¬ì¦˜","ì™¸ê´‘ íšŒí™”","íë¹„ì¦˜","ì¶”ìƒí‘œí˜„ì£¼ì˜","ê°œë…ë¯¸ìˆ "],
references:["í•  í¬ìŠ¤í„° ì™¸ ã€1900ë…„ ì´í›„ì˜ ë¯¸ìˆ ì‚¬ã€"],bridgeText:"ì„œì–‘ë¯¸ìˆ  ì—¬ì •ì„ ë§ˆì¹˜ê³  ë™ì–‘ì˜ ì‹œì„ ìœ¼ë¡œ ë°”ë¼ë³´ê² ìŠµë‹ˆë‹¤.",artworks:[]},
{id:"E01",category:"eastern",title:"í•œêµ­ ë¯¸ìˆ ì‚¬",period:"ì„ ì‚¬~í˜„ëŒ€",hours:10,weekNumber:7,
coreQuestion:"í•œêµ­ ë¯¸ìˆ ì˜ 'ìì—°ì£¼ì˜'ì™€ 'í•´í•™'ì€ ì–´ë””ì„œ ë¹„ë¡¯ë˜ì—ˆëŠ”ê°€?",
concepts:["ê³ êµ¬ë ¤ ê³ ë¶„ë²½í™”","ê³ ë ¤ì²­ì","ì¡°ì„  ì‚°ìˆ˜í™”Â·í’ì†í™”","ë‹¨ìƒ‰í™”"],
references:["ì•ˆíœ˜ì¤€ ã€í•œêµ­ íšŒí™”ì‚¬ã€","ìœ í™ì¤€ ã€ë‚˜ì˜ ë¬¸í™”ìœ ì‚° ë‹µì‚¬ê¸°ã€"],bridgeText:"í•œêµ­ ë¯¸ìˆ ì„ í™•ì¸í•œ ë’¤ ì¤‘êµ­ ë¯¸ìˆ ë¡œ ì‹œì„ ì„ ë„“íˆê² ìŠµë‹ˆë‹¤.",artworks:[]},
{id:"E02",category:"eastern",title:"ì¤‘êµ­ ë¯¸ìˆ ì‚¬",period:"ì€Â·ìƒ~í˜„ëŒ€",hours:10,weekNumber:8,
coreQuestion:"ë¬¸ì¸í™”ì˜ 'ì‚¬ì˜'ëŠ” ì„œì–‘ ì¶”ìƒê³¼ ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€?",
concepts:["ê°‘ê³¨ë¬¸Â·ì²­ë™ê¸°","ì‚°ìˆ˜í™” ì‚¼ì›ë²•","ë¬¸ì¸í™”"],
references:["ë§ˆì´í´ ì„¤ë¦¬ë°˜ ã€The Arts of Chinaã€"],bridgeText:"ëŒ€ë¥™ì˜ ì „í†µ ì˜†ì—ì„œ ì¼ë³¸ì€ ë…ìì  ë¯¸ì˜ì‹ì„ ë°œì „ì‹œì¼°ìŠµë‹ˆë‹¤.",artworks:[]},
{id:"E03",category:"eastern",title:"ì¼ë³¸ ë¯¸ìˆ ì‚¬",period:"ì¡°ëª¬~í˜„ëŒ€",hours:10,weekNumber:9,
coreQuestion:"ì™€ë¹„ì‚¬ë¹„Â·ëª¨ë…¸ë…¸ì•„ì™€ë ˆëŠ” ì¼ë³¸ ë¯¸ìˆ ì˜ ë³¸ì§ˆì¸ê°€?",
concepts:["ìš°í‚¤ìš”ì—","ë¦°íŒŒ","ì¼ë³¸ í˜„ëŒ€ë¯¸ìˆ "],
references:["í˜ë†€ë¡œì‚¬ ã€Epochs of Chinese and Japanese Artã€"],bridgeText:"ë™ì–‘ë¯¸ìˆ ì‚¬ë¥¼ ë§ˆë¬´ë¦¬í•˜ê³  ì „ì‹œê¸°íš ì‹¤ë¬´ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.",artworks:[]},
{id:"X01",category:"exhibition",title:"ì „ì‹œ ê¸°íš ì‹¤ë¬´",period:"ì‹¤ë¬´",hours:16,weekNumber:13,
coreQuestion:"ì¢‹ì€ ì „ì‹œ ì½˜ì…‰íŠ¸ë€ ë¬´ì—‡ì¸ê°€?",
concepts:["ì½˜ì…‰íŠ¸ ê°œë°œ","ì‘ê°€ ë¦¬ì„œì¹˜","ê¸°íšì„œ ì‘ì„±","ê³µê°„ ë””ìì¸","ì˜ˆì‚° í¸ì„±"],
references:["The Artro ê°€ì´ë“œ","í•œêµ­ë¬¸í™”ì˜ˆìˆ ìœ„ì›íšŒ í‘œì¤€ê³„ì•½ì„œ"],bridgeText:"",artworks:[]},
{id:"X02",category:"exhibition",title:"ê³„ì•½ì„œÂ·ì„œë¥˜ ì‘ì„± ì‹¤ë¬´",period:"ì‹¤ë¬´",hours:8,weekNumber:15,
coreQuestion:"ë…ë¦½ íë ˆì´í„°ê°€ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ê³„ì•½ì„œ í•µì‹¬ì€?",
concepts:["ì „ì‹œ ì°¸ì—¬ ê³„ì•½ì„œ","ì‘í’ˆ ëŒ€ì—¬ ê³„ì•½ì„œ","ì»¤ë¯¸ì…˜ ê³„ì•½ì„œ","ì €ì‘ê¶Œ ê³„ì•½","íë ˆì´í„° ìš©ì—­ ê³„ì•½"],
references:["ë¬¸ì²´ë¶€ í‘œì¤€ê³„ì•½ì„œ 12ì¢…"],bridgeText:"",artworks:[]},
{id:"X03",category:"exhibition",title:"ë„ìŠ¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±ë²•",period:"ì‹¤ë¬´",hours:8,weekNumber:16,
coreQuestion:"ê´€ëŒê°ì˜ ë§ˆìŒì„ ì—¬ëŠ” ì²« ë§ˆë””ëŠ”?",
concepts:["5ë‹¨ê³„ ìŠ¤í¬ë¦½íŠ¸ êµ¬ì¡°","4ë‹¨ê³„ í•´ì„¤ë²•(ê´€ì°°â†’ì •ë³´â†’í•´ì„â†’ì§ˆë¬¸)","ì‹œê°„ ë°°ë¶„"],
references:["ê¹€ì¸ì•„ ã€ì „ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì“°ê¸°ã€"],bridgeText:"",artworks:[]}
],generatedScripts:[],aiPipelineLog:[]};

let D,curMod=null,curArt=null,lastScript=null;
let rhTimer=null,rhSec=0,rhPaused=true,rhSections=[],rhCur=0;

function load(){const s=localStorage.getItem('dmv2');if(s){try{D=JSON.parse(s)}catch(e){D=JSON.parse(JSON.stringify(DEF))}}else D=JSON.parse(JSON.stringify(DEF));}
function save(){D.lastUpdated=new Date().toISOString().split('T')[0];localStorage.setItem('dmv2',JSON.stringify(D));stats();}
function resetAll(){if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){localStorage.removeItem('dmv2');location.reload();}}

function stats(){
  let ta=0,v=0;D.modules.forEach(m=>(m.artworks||[]).forEach(a=>{ta++;if(a.verified)v++;}));
  document.getElementById('s-mod').textContent=D.modules.length;
  document.getElementById('s-art').textContent=ta;
  document.getElementById('s-scr').textContent=(D.generatedScripts||[]).length;
  document.getElementById('s-ver').textContent=v;
}

/* â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â• */
const titles={p1:'ğŸ“ ë°ì´í„° ë§¤ë‹ˆì €',p2:'ğŸ“¥ JSON ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°',p3:'ğŸ“ í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸°',p4:'ğŸ›ï¸ ë©”íŠ¸ë¡œí´ë¦¬íƒ„ ë¯¸ìˆ ê´€ API',p5:'ğŸ¤– AI íŒŒì´í”„ë¼ì¸',p6:'â±ï¸ ë¦¬í—ˆì„¤ íƒ€ì´ë¨¸',p7:'ğŸ“¤ ë‚´ë³´ë‚´ê¸°'};
function go(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  document.querySelectorAll('.nav-i').forEach(n=>n.classList.remove('on'));
  event.currentTarget.classList.add('on');
  document.getElementById('ptitle').textContent=titles[id]||'';
  if(id==='p2')updPreview();
}

/* â•â•â•â•â•â• CHIP TOGGLE â•â•â•â•â•â• */
document.addEventListener('click',e=>{
  if(!e.target.classList.contains('chip'))return;
  const p=e.target.parentElement;
  if(['ch-type','ch-aud','ch-tone'].includes(p.id)){
    p.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
    e.target.classList.add('on');
  }else{e.target.classList.toggle('on');}
});

/* â•â•â•â•â•â• TREE â•â•â•â•â•â• */
function renderTree(){
  const t=document.getElementById('tree');
  const cats={western:'ì„œì–‘ë¯¸ìˆ ì‚¬',eastern:'ë™ì–‘ë¯¸ìˆ ì‚¬',exhibition:'ì „ì‹œê¸°íšì‹¤ë¬´'};
  let h='';
  for(const[c,l]of Object.entries(cats)){
    h+=`<div class="tree-cat">${l}</div>`;
    D.modules.filter(m=>m.category===c).forEach(m=>{
      h+=`<div class="tree-i" data-m="${m.id}" onclick="selMod('${m.id}')">ğŸ“‚ ${m.title}</div><div class="tree-ch">`;
      (m.artworks||[]).forEach(a=>{h+=`<div class="tree-i" data-a="${a.id}" onclick="selArt('${m.id}','${a.id}')">${a.verified?'âœ…':'ğŸ“„'} ${a.title}</div>`;});
      h+='</div>';
    });
  }
  t.innerHTML=h;
}

function selMod(id){curMod=id;curArt=null;document.querySelectorAll('.tree-i').forEach(e=>e.classList.remove('on'));document.querySelector(`.tree-i[data-m="${id}"]`)?.classList.add('on');const m=D.modules.find(x=>x.id===id);if(m)showModEditor(m);}
function selArt(mid,aid){curMod=mid;curArt=aid;document.querySelectorAll('.tree-i').forEach(e=>e.classList.remove('on'));document.querySelector(`.tree-i[data-a="${aid}"]`)?.classList.add('on');const m=D.modules.find(x=>x.id===mid),a=m?.artworks?.find(x=>x.id===aid);if(a)showArtEditor(a,m);}

function showModEditor(m){
  document.getElementById('editor').innerHTML=`
  <div style="display:flex;gap:6px;margin-bottom:14px;"><button class="btn btn-g" onclick="saveEd()">ğŸ’¾ ì €ì¥</button><button class="btn" onclick="addArt()">â• ì‘í’ˆ ì¶”ê°€</button><button class="btn btn-r" onclick="delCur()">ğŸ—‘ï¸ ì‚­ì œ</button></div>
  <h3 style="font-family:var(--serif);margin-bottom:14px;">${m.title}</h3>
  <div class="fg"><label>ì œëª©</label><input value="${m.title}" id="e-t"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <div class="fg"><label>ì‹œê¸°</label><input value="${m.period}" id="e-p"></div>
    <div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="e-cat"><option value="western"${m.category==='western'?' selected':''}>ì„œì–‘</option><option value="eastern"${m.category==='eastern'?' selected':''}>ë™ì–‘</option><option value="exhibition"${m.category==='exhibition'?' selected':''}>ì „ì‹œê¸°íš</option></select></div>
  </div>
  <div class="fg"><label>í•µì‹¬ ì§ˆë¬¸</label><textarea id="e-q">${m.coreQuestion}</textarea></div>
  <div class="fg"><label>í•µì‹¬ ê°œë… (ì¤„ë°”ê¿ˆ)</label><textarea id="e-con" rows="3">${(m.concepts||[]).join('\n')}</textarea></div>
  <div class="fg"><label>ì°¸ê³ ë¬¸í—Œ (ì¤„ë°”ê¿ˆ)</label><textarea id="e-ref" rows="3">${(m.references||[]).join('\n')}</textarea></div>
  <div class="fg"><label>ì „í™˜ ë©˜íŠ¸</label><textarea id="e-br">${m.bridgeText||''}</textarea></div>`;
}

function showArtEditor(a,m){
  const f=a.formalAnalysis||{};
  document.getElementById('editor').innerHTML=`
  <div style="display:flex;gap:6px;margin-bottom:14px;"><button class="btn btn-g" onclick="saveEd()">ğŸ’¾ ì €ì¥</button><button class="btn btn-r" onclick="delCur()">ğŸ—‘ï¸ ì‚­ì œ</button></div>
  <h3 style="font-family:var(--serif);">ğŸ–¼ï¸ ${a.title}</h3>
  <span class="badge">${m.title}</span> <span class="badge" style="${a.verified?'background:rgba(78,203,113,.13);color:var(--green)':'background:rgba(232,147,78,.13);color:var(--orange)'}">${a.verified?'âœ… ê²€ì¦ì™„ë£Œ':'â³ ë¯¸ê²€ì¦'}</span>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;">
    <div class="fg"><label>ì œëª©</label><input value="${a.title}" id="ea-t"></div>
    <div class="fg"><label>ì‘ê°€</label><input value="${a.artist}" id="ea-ar"></div>
    <div class="fg"><label>ì—°ë„</label><input value="${a.year}" id="ea-y"></div>
    <div class="fg"><label>ë§¤ì²´</label><input value="${a.medium}" id="ea-m"></div>
    <div class="fg"><label>í¬ê¸°</label><input value="${a.dimensions}" id="ea-d"></div>
    <div class="fg"><label>ì†Œì¥ì²˜</label><input value="${a.museum||''}" id="ea-mu"></div>
  </div>
  <div class="fg"><label>ì´ë¯¸ì§€ URL</label><input value="${a.imageUrl||''}" id="ea-img"></div>
  <hr style="border-color:var(--bd);margin:14px 0;">
  <h4 style="color:var(--cyan);margin-bottom:10px;">ğŸ” í˜•ì‹ ë¶„ì„</h4>
  <div class="fg"><label>êµ¬ë„</label><textarea id="ef-co">${f.composition||''}</textarea></div>
  <div class="fg"><label>ìƒ‰ì±„</label><textarea id="ef-cl">${f.color||''}</textarea></div>
  <div class="fg"><label>ê¸°ë²•</label><textarea id="ef-br">${f.brushwork||''}</textarea></div>
  <div class="fg"><label>ì‹œì„  ìœ ë„</label><textarea id="ef-gz">${f.gazeGuide||''}</textarea></div>
  <hr style="border-color:var(--bd);margin:14px 0;">
  <div class="fg"><label>ğŸ“– ì—­ì‚¬ ë§¥ë½</label><textarea id="ea-ctx" rows="3">${a.historicalContext||''}</textarea></div>
  <div class="fg"><label>ğŸ”„ ë¹„êµ ì‘í’ˆ (ì¤„ë°”ê¿ˆ)</label><textarea id="ea-cmp" rows="2">${(a.comparativeWorks||[]).join('\n')}</textarea></div>
  <div class="fg"><label>â“ ê´€ëŒê° ì§ˆë¬¸</label><textarea id="ea-iq">${a.interactiveQuestion||''}</textarea></div>
  <div class="fg"><label>ğŸ™ï¸ ë„ìŠ¨íŠ¸ ë…¸íŠ¸</label><textarea id="ea-sn" rows="2">${a.speakerNote||''}</textarea></div>
  <div class="fg"><label>ê²€ì¦ ìƒíƒœ</label><select id="ea-v"><option value="true"${a.verified?' selected':''}>âœ… ì™„ë£Œ</option><option value="false"${!a.verified?' selected':''}>â³ ë¯¸ê²€ì¦</option></select></div>`;
}

function saveEd(){
  if(curArt){
    const m=D.modules.find(x=>x.id===curMod),a=m?.artworks?.find(x=>x.id===curArt);if(!a)return;
    a.title=document.getElementById('ea-t').value;a.artist=document.getElementById('ea-ar').value;
    a.year=document.getElementById('ea-y').value;a.medium=document.getElementById('ea-m').value;
    a.dimensions=document.getElementById('ea-d').value;a.museum=document.getElementById('ea-mu').value;
    a.imageUrl=document.getElementById('ea-img').value;
    a.formalAnalysis={composition:document.getElementById('ef-co').value,color:document.getElementById('ef-cl').value,brushwork:document.getElementById('ef-br').value,gazeGuide:document.getElementById('ef-gz').value};
    a.historicalContext=document.getElementById('ea-ctx').value;
    a.comparativeWorks=document.getElementById('ea-cmp').value.split('\n').filter(s=>s.trim());
    a.interactiveQuestion=document.getElementById('ea-iq').value;
    a.speakerNote=document.getElementById('ea-sn').value;
    a.verified=document.getElementById('ea-v').value==='true';
    a.lastModified=new Date().toISOString().split('T')[0];
  }else if(curMod){
    const m=D.modules.find(x=>x.id===curMod);if(!m)return;
    m.title=document.getElementById('e-t').value;m.period=document.getElementById('e-p').value;
    m.category=document.getElementById('e-cat').value;m.coreQuestion=document.getElementById('e-q').value;
    m.concepts=document.getElementById('e-con').value.split('\n').filter(s=>s.trim());
    m.references=document.getElementById('e-ref').value.split('\n').filter(s=>s.trim());
    m.bridgeText=document.getElementById('e-br').value;
  }
  save();renderTree();fillSelects();alert('âœ… ì €ì¥ ì™„ë£Œ');
}

function addArt(){
  if(!curMod){alert('ëª¨ë“ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');return;}
  const m=D.modules.find(x=>x.id===curMod);if(!m.artworks)m.artworks=[];
  const nid=`${m.id}-A${String(m.artworks.length+1).padStart(2,'0')}`;
  m.artworks.push({id:nid,title:'ìƒˆ ì‘í’ˆ',artist:'',year:'',medium:'',dimensions:'',location:'',museum:'',imageUrl:'',formalAnalysis:{composition:'',color:'',brushwork:'',gazeGuide:''},historicalContext:'',comparativeWorks:[],interactiveQuestion:'',speakerNote:'',verified:false,lastModified:new Date().toISOString().split('T')[0]});
  save();renderTree();selArt(m.id,nid);
}

function delCur(){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(curArt){const m=D.modules.find(x=>x.id===curMod);m.artworks=m.artworks.filter(a=>a.id!==curArt);curArt=null;}
  else if(curMod){D.modules=D.modules.filter(m=>m.id!==curMod);curMod=null;}
  save();renderTree();fillSelects();document.getElementById('editor').innerHTML='<p style="color:var(--t3);text-align:center;padding:40px;">ì‚­ì œ ì™„ë£Œ</p>';
}

/* â•â•â•â•â•â• JSON IMPORT/EXPORT â•â•â•â•â•â• */
function jImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=x=>{try{const d=JSON.parse(x.target.result);if(d.modules){D=d;save();renderTree();fillSelects();alert('âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');}else alert('modules í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');}catch(er){alert('íŒŒì‹± ì˜¤ë¥˜:'+er.message);}};r.readAsText(f);}
function jPaste(){try{const d=JSON.parse(document.getElementById('jpaste').value);if(d.modules){D=d;save();renderTree();fillSelects();alert('âœ… ì™„ë£Œ');}else alert('í˜•ì‹ ì˜¤ë¥˜');}catch(e){alert('ì˜¤ë¥˜:'+e.message);}}
function jMerge(){try{const d=JSON.parse(document.getElementById('jpaste').value);if(d.modules){d.modules.forEach(nm=>{const ex=D.modules.find(m=>m.id===nm.id);if(ex){(nm.artworks||[]).forEach(na=>{if(!ex.artworks.find(a=>a.id===na.id))ex.artworks.push(na);});}else D.modules.push(nm);});save();renderTree();fillSelects();alert('âœ… ë³‘í•© ì™„ë£Œ');}else alert('í˜•ì‹ ì˜¤ë¥˜');}catch(e){alert('ì˜¤ë¥˜:'+e.message);}}
function jExport(){const sc=document.getElementById('escope').value;let d;if(sc==='all')d=D;else d={...D,modules:D.modules.filter(m=>m.category===sc)};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`docent_${sc}_${D.lastUpdated}.json`;a.click();URL.revokeObjectURL(u);}
function jCopy(){const sc=document.getElementById('escope').value;let d;if(sc==='all')d=D;else d={...D,modules:D.modules.filter(m=>m.category===sc)};navigator.clipboard.writeText(JSON.stringify(d,null,2)).then(()=>alert('âœ… ë³µì‚¬ ì™„ë£Œ'));}
function dlAll(){jExport();}
function updPreview(){const p=document.getElementById('jprev');if(p)p.value=JSON.stringify(D,null,2).substring(0,3000)+'...';}

/* â•â•â•â•â•â• SCRIPT GENERATOR â•â•â•â•â•â• */
function fillSelects(){
  ['selmod','aimod'].forEach(sid=>{const s=document.getElementById(sid);if(!s)return;s.innerHTML='<option value="">â€” ì„ íƒ â€”</option>';
  const c={western:'ì„œì–‘ë¯¸ìˆ ì‚¬',eastern:'ë™ì–‘ë¯¸ìˆ ì‚¬',exhibition:'ì „ì‹œê¸°íš'};
  for(const[k,l]of Object.entries(c)){const g=document.createElement('optgroup');g.label=l;D.modules.filter(m=>m.category===k).forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.title;g.appendChild(o);});s.appendChild(g);}});
}

function onModSel(){
  const m=D.modules.find(x=>x.id===document.getElementById('selmod').value);
  const l=document.getElementById('artlist');
  if(!m||!m.artworks?.length){l.innerHTML='<p style="font-size:.72rem;color:var(--t3);">ì‘í’ˆ ì—†ìŒ</p>';return;}
  l.innerHTML=m.artworks.map(a=>`<label style="display:flex;align-items:center;gap:6px;padding:5px 6px;font-size:.76rem;cursor:pointer;"><input type="checkbox" checked value="${a.id}" class="ackb"> ${a.title} <span style="color:var(--t3);font-size:.62rem;">(${a.year})</span></label>`).join('');
}

function gv(cid){const a=document.querySelector(`#${cid} .chip.on`);return a?a.dataset.v:'';}
function gvs(cid){return Array.from(document.querySelectorAll(`#${cid} .chip.on`)).map(c=>c.dataset.v);}

function genScript(){
  /* â•â•â•â•â•â• ë¶„ëŸ‰ í™•ì¥ í…ìŠ¤íŠ¸ ìƒì„± ì—”ì§„ â•â•â•â•â•â• */
const EXPAND = {
  openingTemplates: [
    (m) => `ì•ˆë…•í•˜ì„¸ìš”, ë°˜ê°‘ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ì €ì™€ í•¨ê»˜ ${m.title}ì˜ ì„¸ê³„ë¥¼ ì—¬í–‰í•  ì‹œê°„ì…ë‹ˆë‹¤. ë¯¸ìˆ ê´€ì— ì˜¤ì‹œë©´ ê°€ì¥ ë¨¼ì € ë¬´ì—‡ì´ ëˆˆì— ë“¤ì–´ì˜¤ì‹œë‚˜ìš”? ì–´ë–¤ ë¶„ì€ ìƒ‰ì±„ê°€, ì–´ë–¤ ë¶„ì€ ì‘í’ˆì˜ í¬ê¸°ê°€, ë˜ ì–´ë–¤ ë¶„ì€ ì•¡ì ë„ˆë¨¸ë¡œ ëŠê»´ì§€ëŠ” ì‹œëŒ€ì˜ ê³µê¸°ê°€ ë¨¼ì € ì™€ë‹¿ëŠ”ë‹¤ê³  í•˜ì‹­ë‹ˆë‹¤. ì˜¤ëŠ˜ì€ ê·¸ ëª¨ë“  ê°ê°ì„ ì—´ì–´ë‘ê³ , ${m.period} ì‹œëŒ€ì˜ ì‘í’ˆë“¤ì„ í•¨ê»˜ ë§Œë‚˜ë³´ë ¤ í•©ë‹ˆë‹¤.`,
    (m) => m.coreQuestion ? `\n\nì˜¤ëŠ˜ ì—¬ëŸ¬ë¶„ê»˜ í•˜ë‚˜ì˜ ì§ˆë¬¸ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. "${m.coreQuestion}" ì´ ì§ˆë¬¸ì— ëŒ€í•œ ì •ë‹µì€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì˜¤ëŠ˜ ë§Œë‚˜ë³¼ ì‘í’ˆë“¤ í•˜ë‚˜í•˜ë‚˜ê°€ ì´ ì§ˆë¬¸ì— ëŒ€í•œ ë‚˜ë¦„ì˜ ëŒ€ë‹µì„ ë“¤ë ¤ì¤„ ê²ƒì…ë‹ˆë‹¤. ì´ ì§ˆë¬¸ì„ ë§ˆìŒ í•œì¼ ì— ë‘ì‹œê³ , ì‘í’ˆê³¼ ëŒ€í™”í•˜ë“¯ ê°ìƒí•´ ì£¼ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.` : '',
    (m) => m.concepts?.length ? `\n\nì˜¤ëŠ˜ ì—¬í–‰ì˜ ê¸¸ì¡ì´ê°€ ë  í‚¤ì›Œë“œë¥¼ ë¯¸ë¦¬ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ${m.concepts.join(', ')} â€” ì´ ê°œë…ë“¤ì´ ì‘í’ˆ ì†ì—ì„œ ì–´ë–»ê²Œ í¼ì³ì§€ëŠ”ì§€ í•¨ê»˜ í™•ì¸í•´ ë³´ì‹œì£ . ì¤€ë¹„ë˜ì…¨ìœ¼ë©´, ì²« ë²ˆì§¸ ì‘í’ˆ ì•ìœ¼ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆë‹¤.` : ''
  ],

  contextTemplates: [
    (m) => `ì§€ê¸ˆ ìš°ë¦¬ê°€ ì„œ ìˆëŠ” ì‹œê°„ì€ ${m.period}ì…ë‹ˆë‹¤. ì´ ì‹œê¸°ë¥¼ ì´í•´í•˜ë ¤ë©´ ë¨¼ì € ë‹¹ì‹œ ì‚¬ëŒë“¤ì˜ ì„¸ê³„ê´€ ì†ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.`,
    (m) => m.concepts?.length ? `\n\nì´ ì‹œëŒ€ë¥¼ ê´€í†µí•˜ëŠ” í•µì‹¬ ê°œë…ë“¤ì„ í•˜ë‚˜ì”© ì§šì–´ë³´ê² ìŠµë‹ˆë‹¤. ${m.concepts.map((c, i) => `${i === 0 ? 'ì²«ì§¸' : i === 1 ? 'ë‘˜ì§¸' : i === 2 ? 'ì…‹ì§¸' : (i+1)+'ë²ˆì§¸'}ë¡œ "${c}"ì…ë‹ˆë‹¤. ì´ê²ƒì€ ì´ ì‹œëŒ€ ë¯¸ìˆ ì„ ì´í•´í•˜ëŠ” ë° ë¹ ëœ¨ë¦´ ìˆ˜ ì—†ëŠ” ê°œë…ìœ¼ë¡œ, ì´í›„ ì‘í’ˆ í•´ì„¤ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ë“±ì¥í•  ê²ƒì…ë‹ˆë‹¤.`).join(' ')}` : '',
    (m) => `\n\nì´ëŸ¬í•œ ì‹œëŒ€ì  ë°°ê²½ì„ ì—¼ë‘ì— ë‘ì‹œë©´, ì§€ê¸ˆë¶€í„° ë§Œë‚˜ë³¼ ì‘í’ˆë“¤ì´ ì™œ ê·¸ëŸ° ëª¨ìŠµìœ¼ë¡œ íƒ„ìƒí–ˆëŠ”ì§€ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´ê°€ ë˜ì‹¤ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¼ ì²« ë²ˆì§¸ ì‘í’ˆ ì•ìœ¼ë¡œ ê°€ë³´ê² ìŠµë‹ˆë‹¤.`
  ],

  artworkNarrative(a, index, total) {
    let t = '';

    // ë„ì…
    t += index === 0
      ? `ì, ì´ì œ ì˜¤ëŠ˜ì˜ ì²« ë²ˆì§¸ ì‘í’ˆì…ë‹ˆë‹¤. ë°”ë¡œ ${a.artist || 'ì‘ì ë¯¸ìƒ'}ì˜ "${a.title}"ì…ë‹ˆë‹¤.`
      : `ë‹¤ìŒìœ¼ë¡œ ë§Œë‚˜ë³¼ ${index + 1}ë²ˆì§¸ ì‘í’ˆì€ ${a.artist || 'ì‘ì ë¯¸ìƒ'}ì˜ "${a.title}"ì…ë‹ˆë‹¤.`;

    t += ` ${a.year}ì— ì œì‘ëœ ì´ ì‘í’ˆì€ ${a.medium || ''}${a.medium ? '(ìœ¼)ë¡œ ë§Œë“¤ì–´ì¡Œìœ¼ë©°' : ''} í˜„ì¬ ${a.museum || a.location || ''}ì— ì†Œì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;

    if (a.dimensions) {
      t += ` ì‘í’ˆì˜ í¬ê¸°ëŠ” ${a.dimensions}${a.dimensions.includes('cm') || a.dimensions.includes('m') ? 'ì…ë‹ˆë‹¤.' : 'ì…ë‹ˆë‹¤.'} `;
      t += 'ì‹¤ì œë¡œ ë³´ì‹œë©´ ë„íŒìœ¼ë¡œ ë³´ëŠ” ê²ƒê³¼ëŠ” ì „í˜€ ë‹¤ë¥¸ ì••ë„ê°ì„ ëŠë¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }

    // ì—­ì‚¬ ë§¥ë½ í™•ì¥
    t += '\n\n';
    if (a.historicalContext) {
      t += `ì´ ì‘í’ˆì´ ë§Œë“¤ì–´ì§„ ë°°ê²½ì„ ë¨¼ì € ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. ${a.historicalContext}`;
      t += ' ì´ëŸ¬í•œ ì‹œëŒ€ì  ë§¥ë½ì„ ì•Œê³  ë‚˜ë©´, ì‘í’ˆì„ ë°”ë¼ë³´ëŠ” ëˆˆì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ë‹¨ìˆœí•œ ì¡°í˜•ë¬¼ì´ ì•„ë‹ˆë¼, ê·¸ ì‹œëŒ€ ì‚¬ëŒë“¤ì˜ ìƒê°ê³¼ ë¯¿ìŒê³¼ ë‘ë ¤ì›€ì´ ì‘ì¶•ëœ ê¸°ë¡ìœ¼ë¡œ ì½íˆê¸° ì‹œì‘í•©ë‹ˆë‹¤.';
    } else {
      t += `ì´ ì‘í’ˆì´ ë§Œë“¤ì–´ì§„ ${a.year} ë¬´ë µì˜ ì‚¬íšŒì Â·ë¬¸í™”ì  ë°°ê²½ì€ ì‘í’ˆì„ ì´í•´í•˜ëŠ” í•µì‹¬ ì—´ì‡ ì…ë‹ˆë‹¤. ë‹¹ì‹œì˜ ì„¸ê³„ê´€, ê¸°ìˆ  ìˆ˜ì¤€, ì‚¬íšŒì  ìš”êµ¬ê°€ ëª¨ë‘ ì´ ì‘í’ˆì˜ í˜•íƒœì— ì˜í–¥ì„ ë¯¸ì³¤ìŠµë‹ˆë‹¤.`;
    }

    return t;
  },

  formalExpand(fa) {
    let t = '\n\nì´ì œ ì‘í’ˆì„ ì¢€ ë” ìì„¸íˆ ë“¤ì—¬ë‹¤ë³´ê² ìŠµë‹ˆë‹¤.\n\n';

    if (fa.composition) {
      t += `ë¨¼ì € êµ¬ë„ë¥¼ ë³´ê² ìŠµë‹ˆë‹¤. ${fa.composition} ì‘ê°€ê°€ í™”ë©´ì„ ì´ë ‡ê²Œ êµ¬ì„±í•œ ë°ì—ëŠ” ë¶„ëª…í•œ ì˜ë„ê°€ ìˆìŠµë‹ˆë‹¤. ê´€ëŒìì˜ ì‹œì„ ì„ ì–´ë””ë¡œ ìœ ë„í•  ê²ƒì¸ì§€, ì–´ë–¤ ê°ì •ì„ ë¶ˆëŸ¬ì¼ìœ¼í‚¬ ê²ƒì¸ì§€ë¥¼ ì¹˜ë°€í•˜ê²Œ ê³„ì‚°í•œ ê²°ê³¼ì…ë‹ˆë‹¤.\n\n`;
    }

    if (fa.color) {
      t += `ìƒ‰ì±„ë¥¼ ì‚´í´ë³´ë©´, ${fa.color} ìƒ‰ì€ ë‹¨ìˆœí•œ ì¥ì‹ì´ ì•„ë‹ˆë¼ í•˜ë‚˜ì˜ ì–¸ì–´ì…ë‹ˆë‹¤. ì´ ì‘í’ˆì—ì„œ ìƒ‰ì±„ê°€ ì „ë‹¬í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì²œì²œíˆ ì½ì–´ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
    }

    if (fa.brushwork) {
      t += `ê¸°ë²•ì  ì¸¡ë©´ì—ì„œ ë³´ë©´, ${fa.brushwork} ì´ëŸ¬í•œ ê¸°ë²•ì€ ë‹¹ì‹œì˜ ê¸°ìˆ ì  ì¡°ê±´ê³¼ ì‘ê°€ì˜ ì˜ˆìˆ ì  ì˜ë„ê°€ ë§Œë‚˜ëŠ” ì§€ì ì—ì„œ íƒ„ìƒí•œ ê²ƒì…ë‹ˆë‹¤.\n\n`;
    }

    if (fa.gazeGuide) {
      t += `ì´ ì‘í’ˆì„ ê°ìƒí•˜ì‹¤ ë•Œ ì‹œì„ ì˜ ìˆœì„œë¥¼ ì œì•ˆë“œë¦¬ê² ìŠµë‹ˆë‹¤. ${fa.gazeGuide} ì´ ìˆœì„œëŒ€ë¡œ ë³´ì‹œë©´ ì‘ê°€ê°€ ì˜ë„í•œ ì„œì‚¬ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ê°€ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n`;
    }

    return t;
  },

  comparativeExpand(works) {
    let t = 'ì´ ì‘í’ˆì„ ë” ê¹Šì´ ì´í•´í•˜ê¸° ìœ„í•´, í•¨ê»˜ ë¹„êµí•  ë§Œí•œ ì‘í’ˆë“¤ì„ ì†Œê°œí•˜ê² ìŠµë‹ˆë‹¤.\n\n';
    works.forEach((w, i) => {
      t += `${i === 0 ? 'ì²« ë²ˆì§¸' : i === 1 ? 'ë‘ ë²ˆì§¸' : (i+1)+'ë²ˆì§¸'} ë¹„êµì‘ì€ ${w}ì…ë‹ˆë‹¤. `;
      t += i === 0
        ? 'ì´ ì‘í’ˆê³¼ ë‚˜ë€íˆ ë†“ê³  ë³´ë©´, ê°™ì€ ì‹œëŒ€ í˜¹ì€ ê°™ì€ ì£¼ì œë¥¼ ë‹¤ë£¨ë©´ì„œë„ ì ‘ê·¼ ë°©ì‹ì´ ì–´ë–»ê²Œ ë‹¤ë¥¸ì§€ í¥ë¯¸ë¡œìš´ ì°¨ì´ê°€ ë“œëŸ¬ë‚©ë‹ˆë‹¤.\n\n'
        : 'ì´ ì‘í’ˆê³¼ì˜ ë¹„êµë¥¼ í†µí•´ ìš°ë¦¬ê°€ ì§€ê¸ˆ ë³´ê³  ìˆëŠ” ì‘í’ˆë§Œì˜ ë…ìì ì¸ ìœ„ì¹˜ë¥¼ ë”ìš± ëª…í™•í•˜ê²Œ íŒŒì•…í•˜ì‹¤ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.\n\n';
    });
    return t;
  },

  interactiveExpand(q) {
    return `ì—¬ê¸°ì„œ ì ì‹œ, ì—¬ëŸ¬ë¶„ê»˜ ì§ˆë¬¸ì„ í•˜ë‚˜ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\n${q}\n\nì •ë‹µì´ ìˆëŠ” ì§ˆë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤. ê°ìì˜ ê²½í—˜ê³¼ ê°ì„±ì— ë”°ë¼ ì „í˜€ ë‹¤ë¥¸ ë‹µì´ ë‚˜ì˜¬ ìˆ˜ ìˆê³ , ê·¸ê²ƒì´ ë°”ë¡œ ë¯¸ìˆ  ê°ìƒì˜ ë§¤ë ¥ì…ë‹ˆë‹¤. ì ì‹œ ìƒê°í•´ ë³´ì‹œê³ , ì˜†ì— ê³„ì‹  ë¶„ê³¼ ì´ì•¼ê¸° ë‚˜ëˆ„ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.\n\n`;
  },

  bridgeExpand(current, next) {
    return `"${current.title}"ì„(ë¥¼) ì¶©ë¶„íˆ ê°ìƒí•˜ì…¨ìœ¼ë¦¬ë¼ ìƒê°í•©ë‹ˆë‹¤. ì´ ì‘í’ˆì´ ì „í•´ì¤€ ì´ì•¼ê¸°ë¥¼ ë§ˆìŒì— ë‹´ì•„ë‘ì‹œê³ , ì´ì œ ë‹¤ìŒ ì‘í’ˆìœ¼ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë§Œë‚˜ë³¼ "${next.title}"ì€(ëŠ”) ì§€ê¸ˆ ë³´ì‹  ì‘í’ˆê³¼ëŠ” ë˜ ë‹¤ë¥¸ ì„¸ê³„ë¥¼ ë³´ì—¬ì¤„ ê²ƒì…ë‹ˆë‹¤. ì–´ë–¤ ì ì´ ê°™ê³  ì–´ë–¤ ì ì´ ë‹¤ë¥¸ì§€ ë¹„êµí•˜ë©° ê°ìƒí•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
  },

  closingTemplates: [
    (m, count) => `ì˜¤ëŠ˜ ì´ ${count}ì ì˜ ì‘í’ˆì„ í•¨ê»˜ ê°ìƒí•˜ì…¨ìŠµë‹ˆë‹¤. ${m.title}ì´ë¼ëŠ” í° ì£¼ì œ ì•„ë˜ ê°ê¸° ë‹¤ë¥¸ ì´ì•¼ê¸°ë¥¼ ê°€ì§„ ì‘í’ˆë“¤ì„ ë§Œë‚˜ë³´ì…¨ëŠ”ë°, ì–´ë– ì…¨ë‚˜ìš”?`,
    (m) => m.coreQuestion ? `\n\nì˜¤ëŠ˜ ì²˜ìŒì— ë“œë ¸ë˜ ì§ˆë¬¸ì„ ë‹¤ì‹œ êº¼ë‚´ë³´ê² ìŠµë‹ˆë‹¤. "${m.coreQuestion}" í•´ì„¤ì„ ë“£ê¸° ì „ê³¼ í›„, ì´ ì§ˆë¬¸ì— ëŒ€í•œ ì—¬ëŸ¬ë¶„ì˜ ìƒê°ì´ ì¡°ê¸ˆì´ë¼ë„ ë‹¬ë¼ì§€ì…¨ë‹¤ë©´, ì˜¤ëŠ˜ ì—¬í–‰ì€ ì„±ê³µì…ë‹ˆë‹¤. ë¬¼ë¡  ì •ë‹µì€ ì—†ìŠµë‹ˆë‹¤. ë¯¸ìˆ ì‚¬ì˜ ë§¤ë ¥ì€ ë°”ë¡œ í•˜ë‚˜ì˜ ì§ˆë¬¸ì´ ìˆ˜ë°± ê°€ì§€ ë‹µì„ í’ˆê³  ìˆë‹¤ëŠ” ì ì— ìˆìœ¼ë‹ˆê¹Œìš”.` : '',
    () => `\n\nì˜¤ëŠ˜ ë³´ì‹  ì‘í’ˆë“¤ì„ ê¸°ì–µí•˜ì‹¤ ë•Œ, ì œê°€ ë§ì”€ë“œë¦° ì •ë³´ë³´ë‹¤ ì—¬ëŸ¬ë¶„ì´ ì§ì ‘ ëŠë¼ì‹  ê°ì •ê³¼ ì¸ìƒì„ ë” ì†Œì¤‘íˆ ê°„ì§í•´ ì£¼ì„¸ìš”. ê·¸ê²ƒì´ ì§„ì •í•œ ë¯¸ìˆ  ê°ìƒì˜ í•µì‹¬ì…ë‹ˆë‹¤. ë‹¤ìŒì— ë¯¸ìˆ ê´€ì—ì„œ ë‹¤ì‹œ ë§Œë‚˜ëµ™ê² ìŠµë‹ˆë‹¤. í•¨ê»˜í•´ ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬í•©ë‹ˆë‹¤.`
  ],

  speakerNoteExpand(note) {
    return `[ë„ìŠ¨íŠ¸ ì°¸ê³ ] ${note}`;
  }
};

/* â•â•â•â•â•â• A4 ë¶„ëŸ‰ ê³„ì‚° â•â•â•â•â•â• */
// A4 1ì¥ â‰ˆ í•œê¸€ ê¸°ì¤€ ì•½ 1,400~1,800ì (11pt, ì¤„ê°„ê²© 160%)
// ë³´ìˆ˜ì ìœ¼ë¡œ 1,500ì/ì¥ ê¸°ì¤€
const A4_CHARS = 1500;

function genScript(){
  const mid=document.getElementById('selmod').value,m=D.modules.find(x=>x.id===mid);
  if(!m){alert('ëª¨ë“ˆì„ ì„ íƒí•˜ì„¸ìš”');return;}
  const type=gv('ch-type'),dur=+document.getElementById('dur').value,aud=gv('ch-aud'),tone=gv('ch-tone'),els=gvs('ch-el');
  const sIds=Array.from(document.querySelectorAll('.ackb:checked')).map(c=>c.value);
  const arts=(m.artworks||[]).filter(a=>sIds.includes(a.id));
  const mpa=arts.length?Math.floor((dur-6)/arts.length):dur;

  // ëª©í‘œ ë¶„ëŸ‰ (A4 ì¥ìˆ˜) ê°€ì ¸ì˜¤ê¸°
  const targetPages = parseInt(document.getElementById('target-pages')?.value || '4');
  const targetChars = targetPages * A4_CHARS;

  let h='',plainText='',out=document.getElementById('sout');
  rhSections=[];

  // Header
  h+=`<div style="margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--bd);">
    <h2 style="font-family:var(--serif);">${m.title}</h2>
    <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
      <span class="badge">${type==='docent'?'ë„ìŠ¨íŠ¸ í•´ì„¤':type==='lecture'?'ê°•ì˜':'ê¸°íš ë°œí‘œ'}</span>
      <span class="badge" style="background:rgba(91,141,239,.13);color:var(--blue);">${dur}ë¶„</span>
      <span class="badge" style="background:rgba(78,203,113,.13);color:var(--green);">${aud}</span>
      <span class="badge" style="background:rgba(166,120,232,.13);color:var(--purple);">ëª©í‘œ A4 ${targetPages}ì¥ (${targetChars.toLocaleString()}ì)</span>
    </div>
  </div>`;

  // â”€â”€ OPENING
  if(els.includes('opening')){
    let txt = EXPAND.openingTemplates.map(fn => fn(m)).join('');
    h+=sb('','ğŸ¤ ì˜¤í”„ë‹',nl2br(txt),'2~3ë¶„');
    plainText += txt + '\n\n';
    rhSections.push({name:'ì˜¤í”„ë‹',min:3});
  }

  // â”€â”€ CONTEXT
  if(els.includes('context')){
    let txt = EXPAND.contextTemplates.map(fn => fn(m)).join('');
    h+=sb('ctx','ğŸ“– ì‹œëŒ€ ë§¥ë½',nl2br(txt),'3~4ë¶„');
    plainText += txt + '\n\n';
    rhSections.push({name:'ì‹œëŒ€ ë§¥ë½',min:4});
  }

  // â”€â”€ ARTWORKS
  arts.forEach((a,i)=>{
    if(els.includes('artwork')){
      // ì‘í’ˆ í—¤ë”
      h+=`<div style="margin:22px 0 6px;padding-top:14px;border-top:2px solid var(--bd);">
        <h3 style="font-family:var(--serif);">${i+1}. ${a.title}</h3>
        <div style="font-size:.72rem;color:var(--t3);margin-top:3px;">
          ${a.artist} | ${a.year} | ${a.medium} | ${a.museum||''}
        </div>
        ${a.imageUrl?`<img src="${a.imageUrl}" style="max-width:100%;border-radius:10px;margin:10px 0;">`:''}</div>`;

      // ì‘í’ˆ í•´ì„¤ (í™•ì¥)
      let artTxt = EXPAND.artworkNarrative(a, i, arts.length);
      h+=sb('art','ğŸ–¼ï¸ ì‘í’ˆ í•´ì„¤',nl2br(artTxt),mpa+'ë¶„');
      plainText += artTxt + '\n\n';
      rhSections.push({name:a.title,min:mpa});
    }

    // í˜•ì‹ ë¶„ì„ (í™•ì¥)
    if(els.includes('formal')&&a.formalAnalysis){
      const fa = a.formalAnalysis;
      if(fa.composition||fa.color||fa.brushwork||fa.gazeGuide){
        let fTxt = EXPAND.formalExpand(fa);
        h+=sb('formal','ğŸ” í˜•ì‹ ë¶„ì„',nl2br(fTxt),'');
        plainText += fTxt + '\n\n';
      }
    }

    // ë¹„êµ ì‘í’ˆ (í™•ì¥)
    if(els.includes('comparative')&&a.comparativeWorks?.length){
      let cTxt = EXPAND.comparativeExpand(a.comparativeWorks);
      h+=sb('ctx','ğŸ”„ ë¹„êµ ì‘í’ˆ',nl2br(cTxt),'');
      plainText += cTxt + '\n\n';
    }

    // ê´€ëŒê° ì§ˆë¬¸ (í™•ì¥)
    if(els.includes('interactive')&&a.interactiveQuestion){
      let iTxt = EXPAND.interactiveExpand(a.interactiveQuestion);
      h+=sb('inter','â“ ê´€ëŒê° ì°¸ì—¬',nl2br(iTxt),'');
      plainText += iTxt + '\n\n';
    }

    // ë„ìŠ¨íŠ¸ ë…¸íŠ¸
    if(els.includes('note')&&a.speakerNote){
      let nTxt = EXPAND.speakerNoteExpand(a.speakerNote);
      h+=sb('note','ğŸ™ï¸ ë„ìŠ¨íŠ¸ ë…¸íŠ¸ [ë¹„ê³µê°œ]',nl2br(nTxt),'');
      plainText += nTxt + '\n\n';
    }

    // ì „í™˜ ë©˜íŠ¸ (í™•ì¥)
    if(els.includes('bridge')&&i<arts.length-1){
      let bTxt = EXPAND.bridgeExpand(a, arts[i+1]);
      h+=sb('bridge','â¡ï¸ ì „í™˜',nl2br(bTxt),'');
      plainText += bTxt + '\n\n';
    }
  });

  // ëª¨ë“ˆ ì „í™˜ ë©˜íŠ¸
  if(els.includes('bridge')&&m.bridgeText){
    h+=sb('bridge','â¡ï¸ ì‹œëŒ€ ì „í™˜',nl2br(m.bridgeText),'');
    plainText += m.bridgeText + '\n\n';
  }

  // â”€â”€ CLOSING
  if(els.includes('closing')){
    let cTxt = EXPAND.closingTemplates.map(fn => fn(m, arts.length)).join('');
    h+=sb('','ğŸ¬ í´ë¡œì§•',nl2br(cTxt),'2~3ë¶„');
    plainText += cTxt + '\n\n';
    rhSections.push({name:'í´ë¡œì§•',min:3});
  }

  // â”€â”€ REFERENCES
  if(els.includes('refs')&&m.references?.length){
    h+=`<div class="sblock" style="border-left-color:var(--t3);background:rgba(255,255,255,.02);">
      <div class="sblock-lb" style="color:var(--t3);">ğŸ“š ì°¸ê³ ë¬¸í—Œ</div>
      <div style="font-size:.76rem;color:var(--t2);">${m.references.map(r=>'â€¢ '+r).join('<br>')}</div>
    </div>`;
    plainText += 'ì°¸ê³ ë¬¸í—Œ:\n' + m.references.map(r=>'â€¢ '+r).join('\n') + '\n\n';
  }

  // â”€â”€ ë¶„ëŸ‰ í†µê³„
  const pureLen = plainText.replace(/\s/g,'').length;
  const pureWithSpaces = plainText.length;
  const pages = (pureLen / A4_CHARS).toFixed(1);
  const minutes = Math.round(pureLen / 300);
  const pct = Math.min(100, Math.round((pureLen / targetChars) * 100));
  const pctColor = pct >= 90 ? 'var(--green)' : pct >= 60 ? 'var(--orange)' : 'var(--red)';

  h+=`<div style="margin-top:20px;padding:16px;border:1px solid var(--bd);border-radius:10px;background:var(--bg0);">
    <div style="font-size:.72rem;font-weight:700;color:var(--gold);margin-bottom:10px;">ğŸ“Š ë¶„ëŸ‰ ë¶„ì„</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;">
      <div style="text-align:center;"><div style="font-size:1.3rem;font-weight:900;color:var(--t1);">${pureLen.toLocaleString()}</div><div style="font-size:.62rem;color:var(--t3);">ìˆœìˆ˜ ê¸€ììˆ˜ (ê³µë°±ì œì™¸)</div></div>
      <div style="text-align:center;"><div style="font-size:1.3rem;font-weight:900;color:var(--blue);">${pages}</div><div style="font-size:.62rem;color:var(--t3);">A4 í™˜ì‚° (ì¥)</div></div>
      <div style="text-align:center;"><div style="font-size:1.3rem;font-weight:900;color:var(--purple);">${minutes}</div><div style="font-size:.62rem;color:var(--t3);">ì˜ˆìƒ ë°œí™” (ë¶„)</div></div>
      <div style="text-align:center;"><div style="font-size:1.3rem;font-weight:900;color:${pctColor};">${pct}%</div><div style="font-size:.62rem;color:var(--t3);">ëª©í‘œ ë‹¬ì„±ë¥ </div></div>
    </div>
    <div style="background:var(--bg2);border-radius:6px;height:8px;overflow:hidden;">
      <div style="height:100%;width:${pct}%;background:${pctColor};border-radius:6px;transition:width .5s;"></div>
    </div>
    <div style="font-size:.65rem;color:var(--t3);margin-top:6px;">ëª©í‘œ: A4 ${targetPages}ì¥ (${targetChars.toLocaleString()}ì) | í˜„ì¬: ${pureLen.toLocaleString()}ì (${pct}%)</div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" onclick="expTxt()">ğŸ“¥ TXT</button>
      <button class="btn" onclick="expClip()">ğŸ“‹ ë³µì‚¬</button>
    </div>
  </div>`;

  out.innerHTML=h;
  lastScript=plainText;
  D.generatedScripts.push({date:new Date().toISOString(),module:m.title,type,duration:dur,chars:pureLen,pages:parseFloat(pages)});
  save();
  renderRhList();
}

function nl2br(str){ return (str||'').replace(/\n/g,'<br>'); }

function sb(cls,label,text,time){
  return`<div class="sblock ${cls}"><div class="sblock-lb">${label}${time?`<span class="time-b">â± ${time}</span>`:''}</div><div class="sblock-tx">${text}</div></div>`;
}

/* â•â•â•â•â•â• MET API â•â•â•â•â•â• */
async function metSearch(){
  const q=document.getElementById('met-q').value.trim();if(!q){alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  const dept=document.getElementById('met-dept').value,hl=document.getElementById('met-hl').value;
  document.getElementById('met-status').textContent='ğŸ” ê²€ìƒ‰ ì¤‘...';
  let url=`https://collectionapi.metmuseum.org/public/collection/v1/search?hasImages=true&q=${encodeURIComponent(q)}`;
  if(dept)url+=`&departmentId=${dept}`;if(hl)url+=`&isHighlight=${hl}`;
  try{
    const res=await fetch(url),data=await res.json();
    if(!data.objectIDs?.length){document.getElementById('met-grid').innerHTML='<p style="color:var(--t3);grid-column:1/-1;text-align:center;padding:20px;">ê²°ê³¼ ì—†ìŒ</p>';document.getElementById('met-status').textContent='ê²°ê³¼ ì—†ìŒ';document.getElementById('met-cnt').textContent='';return;}
    document.getElementById('met-cnt').textContent=`ì´ ${data.total}ê±´ (ìƒìœ„ 20ê°œ í‘œì‹œ)`;
    document.getElementById('met-status').textContent=`âœ… ${data.total}ê±´ ë°œê²¬`;
    const ids=data.objectIDs.slice(0,20);
    const grid=document.getElementById('met-grid');grid.innerHTML='';
    for(const id of ids){
      try{
        const r2=await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`),obj=await r2.json();
        const img=obj.primaryImageSmall||'';
        const card=document.createElement('div');card.className='art-card';
        card.innerHTML=`${img?`<img src="${img}" loading="lazy" alt="${obj.title}">`:`<div style="height:150px;background:var(--bg0);display:flex;align-items:center;justify-content:center;color:var(--t3);">ğŸ–¼ï¸</div>`}<div class="info"><div class="t">${obj.title||'ì œëª© ì—†ìŒ'}</div><div class="a">${obj.artistDisplayName||obj.culture||''}</div><div class="a">${obj.objectDate||''}</div></div>`;
        card.onclick=()=>showMetDetail(obj);
        grid.appendChild(card);
      }catch(e){}
    }
  }catch(e){document.getElementById('met-status').textContent='âŒ ì˜¤ë¥˜: '+e.message;}
}

/* â˜… ì‹œëŒ€ ìë™ë§¤ì¹­ ì—”ì§„ â€” ì´ ë¶€ë¶„ë§Œ v2.0ì— ì¶”ê°€ â˜… */

const ERA_RULES = [
  { moduleId:'W01', label:'ì„ ì‚¬Â·ê³ ëŒ€ ê·¼ë™', min:-100000, max:-332,
    depts:['Egyptian Art','Ancient Near Eastern Art'],
    hints:['egyptian','sumerian','babylonian','prehistoric'] },
  { moduleId:'W02', label:'ê·¸ë¦¬ìŠ¤Â·ë¡œë§ˆ', min:-800, max:476,
    depts:['Greek and Roman Art'],
    hints:['greek','roman','etruscan','hellenistic'] },
  { moduleId:'W03', label:'ì¤‘ì„¸', min:476, max:1400,
    depts:['Medieval Art','The Cloisters'],
    hints:['byzantine','romanesque','gothic','medieval'] },
  { moduleId:'W04', label:'ë¥´ë„¤ìƒìŠ¤Â·ë§¤ë„ˆë¦¬ì¦˜', min:1400, max:1600,
    depts:[],
    hints:['renaissance','florentine','venetian','manneris'] },
  { moduleId:'W05', label:'ë°”ë¡œí¬~í˜„ëŒ€', min:1600, max:2100,
    depts:['European Paintings','Modern Art','Photographs'],
    hints:['baroque','rococo','impressionist','modern','contemporary'] },
  { moduleId:'E01', label:'í•œêµ­ ë¯¸ìˆ ', min:-100000, max:2100,
    depts:[],
    hints:['korean','korea','goryeo','joseon','silla','baekje','goguryeo'] },
  { moduleId:'E02', label:'ì¤‘êµ­ ë¯¸ìˆ ', min:-100000, max:2100,
    depts:[],
    hints:['chinese','china','ming','qing','song','tang','yuan','shang','zhou'] },
  { moduleId:'E03', label:'ì¼ë³¸ ë¯¸ìˆ ', min:-100000, max:2100,
    depts:[],
    hints:['japanese','japan','edo','meiji','heian','kamakura','ukiyo'] },
];

function matchEra(obj) {
  const begin = obj.objectBeginDate;
  const dept = (obj.department || '').toLowerCase();
  const combined = [obj.culture, obj.period, obj.department,
                    obj.artistNationality, obj.title]
                    .map(s => (s||'').toLowerCase()).join(' ');

  let best = null, bestScore = -1;

  for (const rule of ERA_RULES) {
    let score = 0;

    // 1) ì—°ë„ ë§¤ì¹­
    if (begin != null && !isNaN(begin)) {
      if (begin >= rule.min && begin < rule.max) {
        score += ['E01','E02','E03'].includes(rule.moduleId) ? 5 : 30;
      }
    }

    // 2) ë¶€ì„œ ë§¤ì¹­
    for (const d of rule.depts) {
      if (dept.includes(d.toLowerCase())) score += 25;
    }

    // 3) ë¬¸í™”Â·í‚¤ì›Œë“œ ë§¤ì¹­
    for (const h of rule.hints) {
      if (combined.includes(h)) score += 20;
    }

    if (score > bestScore) { bestScore = score; best = rule; }
  }

  // Asian Art ë¶€ì„œ fallback
  if (dept.includes('asian art') && best && !best.moduleId.startsWith('E')) {
    if (combined.match(/korea|goryeo|joseon|silla/)) best = ERA_RULES.find(r=>r.moduleId==='E01');
    else if (combined.match(/china|chinese|ming|qing|song|tang/)) best = ERA_RULES.find(r=>r.moduleId==='E02');
    else if (combined.match(/japan|japanese|edo|meiji/)) best = ERA_RULES.find(r=>r.moduleId==='E03');
    else best = ERA_RULES.find(r=>r.moduleId==='E02');
  }

  // ìµœì¢… fallback
  if (!best || bestScore === 0) {
    if (begin != null && !isNaN(begin)) {
      for (const r of ERA_RULES.filter(r=>r.moduleId.startsWith('W'))) {
        if (begin >= r.min && begin < r.max) { best = r; break; }
      }
    }
    if (!best) best = ERA_RULES[4];
  }

  const confidence = bestScore >= 30 ? 'ë†’ìŒ' : bestScore >= 15 ? 'ë³´í†µ' : 'ë‚®ìŒ';
  return { rule: best, score: bestScore, confidence };
}

/* â•â•â•â•â•â• df í—¬í¼ í•¨ìˆ˜ ì¶”ê°€ â•â•â•â•â•â• */
function df(l,v){return v?`<div class="df"><div class="dl">${l}</div><div class="dv">${v}</div></div>`:'';}

/* â•â•â•â•â•â• ì„ì‹œ ì €ì¥ì†Œ: í´ë¦­í•œ ì‘í’ˆ ê°ì²´ ë³´ê´€ â•â•â•â•â•â• */
let _lastMetObj = null;

function showMetDetail(o) {
  _lastMetObj = o;
  const match = matchEra(o);
  const conf = match.confidence;
  const confColor = conf==='ë†’ìŒ' ? 'var(--green)' : conf==='ë³´í†µ' ? 'var(--orange)' : 'var(--red)';
  const confIcon = conf==='ë†’ìŒ' ? 'ğŸŸ¢' : conf==='ë³´í†µ' ? 'ğŸŸ¡' : 'ğŸ”´';

  const p = document.getElementById('met-detail');
  p.innerHTML = `
    ${o.primaryImage ? `<img src="${o.primaryImage}" alt="" style="width:100%;border-radius:10px;margin-bottom:14px;">` : ''}
    <h3 style="font-family:var(--serif);margin-bottom:12px;">${o.title||'ì œëª© ì—†ìŒ'}</h3>
    ${df('ì‘ê°€', o.artistDisplayName)}
    ${df('ì—°ë„', o.objectDate)}
    ${df('ë§¤ì²´', o.medium)}
    ${df('í¬ê¸°', o.dimensions)}
    ${df('ë¶€ì„œ', o.department)}
    ${df('ë¬¸í™”', o.culture)}
    ${df('ì‹œëŒ€', o.period)}
    ${df('êµ­ì ', o.artistNationality)}

    <div style="background:var(--bg0);border:1px solid var(--bd);border-radius:10px;padding:14px;margin-top:16px;">
      <div style="font-size:.72rem;font-weight:700;color:var(--gold);margin-bottom:10px;">
        ğŸ¯ ì‹œëŒ€ ìë™ë§¤ì¹­ ê²°ê³¼
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <span style="font-size:1.2rem;">${confIcon}</span>
        <div>
          <div style="font-size:.9rem;font-weight:700;">${match.rule.label}</div>
          <div style="font-size:.68rem;color:${confColor};">ì‹ ë¢°ë„: ${conf} (ì ìˆ˜: ${match.score})</div>
        </div>
      </div>
      <div style="font-size:.72rem;color:var(--t3);margin-bottom:10px;">
        ë§¤ì¹­ ê·¼ê±°: ì—°ë„ ${o.objectBeginDate!=null?o.objectBeginDate:'?'}~${o.objectEndDate!=null?o.objectEndDate:'?'}
        ${o.department ? ' | ë¶€ì„œ: '+o.department : ''}
        ${o.culture ? ' | ë¬¸í™”: '+o.culture : ''}
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span style="font-size:.72rem;color:var(--t2);">ë°°ì • ëª¨ë“ˆ:</span>
        <select id="manual-match" style="flex:1;background:var(--bg0);border:1px solid var(--bd);color:var(--t1);padding:6px;border-radius:6px;font-size:.78rem;">
          ${D.modules.map(m =>
            '<option value="'+m.id+'"'+(m.id===match.rule.moduleId?' selected':'')+'>'+m.id+' â€” '+m.title+'</option>'
          ).join('')}
        </select>
      </div>
      <button class="btn btn-g" style="width:100%;" onclick="doImport()">
        ğŸ“¥ ì´ ëª¨ë“ˆì— ê°€ì ¸ì˜¤ê¸°
      </button>
    </div>
  `;
}

function doImport() {
  const o = _lastMetObj;
  if (!o) { alert('ì‘í’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í´ë¦­í•´ ì£¼ì„¸ìš”.'); return; }

  const targetId = document.getElementById('manual-match').value;
  const m = D.modules.find(x => x.id === targetId);
  if (!m) { alert('ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  if (!m.artworks) m.artworks = [];

  const nid = m.id + '-MET' + o.objectID;
  if (m.artworks.find(a => a.id === nid)) { alert('ì´ë¯¸ ê°€ì ¸ì˜¨ ì‘í’ˆì…ë‹ˆë‹¤'); return; }

  m.artworks.push({
    id: nid,
    title: o.title || '',
    artist: o.artistDisplayName || '',
    year: o.objectDate || '',
    medium: o.medium || '',
    dimensions: o.dimensions || '',
    location: o.country || '',
    museum: 'The Metropolitan Museum of Art',
    imageUrl: o.primaryImageSmall || '',
    formalAnalysis: { composition:'', color:'', brushwork:'', gazeGuide:'' },
    historicalContext: [o.artistDisplayBio||'', o.period ? 'ì‹œëŒ€: '+o.period : '', o.culture ? 'ë¬¸í™”: '+o.culture : ''].filter(Boolean).join(' | '),
    comparativeWorks: [],
    interactiveQuestion: '',
    speakerNote: '',
    verified: false,
    lastModified: new Date().toISOString().split('T')[0]
  });

  save(); renderTree(); fillSelects();
  alert('âœ… "' + o.title + '"\nâ†’ [' + m.id + '] ' + m.title + ' ëª¨ë“ˆì— ì €ì¥ ì™„ë£Œ');
}

/* â•â•â•â•â•â• AI PIPELINE â•â•â•â•â•â• */
function buildPrompt(){
  const mid=document.getElementById('aimod').value,m=D.modules.find(x=>x.id===mid);
  if(!m){alert('ëª¨ë“ˆì„ ì„ íƒí•˜ì„¸ìš”');return;}
  const inst=document.getElementById('aiinst').value;
  const p=`ë‹¹ì‹ ì€ 25ë…„ ê²½ë ¥ì˜ íë ˆì´í„°ì´ì ì „ë¬¸ ë„ìŠ¨íŠ¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ ëª¨ë“ˆ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 40ë¶„ ë¶„ëŸ‰ì˜ ë„ìŠ¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

== ëª¨ë“ˆ ì •ë³´ ==
ì œëª©: ${m.title}
ì‹œê¸°: ${m.period}
í•µì‹¬ ì§ˆë¬¸: ${m.coreQuestion}
í•µì‹¬ ê°œë…: ${(m.concepts||[]).join(', ')}

== ë“±ë¡ëœ ì‘í’ˆ ==
${(m.artworks||[]).map((a,i)=>`${i+1}. ${a.title} (${a.artist}, ${a.year}) â€” ${a.medium}
   ì†Œì¥: ${a.museum||a.location||''}
   ë§¥ë½: ${a.historicalContext||'(ë¯¸ì…ë ¥)'}
`).join('\n')}

== ìŠ¤í¬ë¦½íŠ¸ ìš”êµ¬ì‚¬í•­ ==
1. ê° ì‘í’ˆë³„ë¡œ í¬í•¨: í˜•ì‹ë¶„ì„(êµ¬ë„/ìƒ‰ì±„/ê¸°ë²•/ì‹œì„ ìœ ë„), ì—­ì‚¬ë§¥ë½, ë¹„êµì‘í’ˆ 2ê°œ, ê´€ëŒê° ì°¸ì—¬ ì§ˆë¬¸ 1ê°œ
2. ì˜¤í”„ë‹(í•µì‹¬ ì§ˆë¬¸ ì œì‹œ)ê³¼ í´ë¡œì§•(ì§ˆë¬¸ íšŒìˆ˜) í¬í•¨
3. ì‘í’ˆ ê°„ ì „í™˜ ë©˜íŠ¸ í¬í•¨
4. ê° ì„¹ì…˜ì— â± ì‹œê°„ í‘œì‹œ
5. ë„ìŠ¨íŠ¸ ë…¸íŠ¸(ì œìŠ¤ì²˜, ê°•ì¡°ì , íƒ€ì´ë° íŒíŠ¸)ë¥¼ [NOTE] íƒœê·¸ë¡œ í‘œì‹œ
${inst?'\n== ì¶”ê°€ ì§€ì‹œì‚¬í•­ ==\n'+inst:''}

ì „ë¬¸ì ì´ë©´ì„œë„ ë”°ëœ»í•œ ì–´ì¡°ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;
  document.getElementById('aiprompt').value=p;
}

async function callAI(){
  const key=document.getElementById('aikey').value.trim();
  if(!key){alert('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  const prompt=document.getElementById('aiprompt').value;
  if(!prompt){alert('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”');return;}
  document.getElementById('ai-status').innerHTML='<span style="color:var(--orange);">ğŸ”„ AI ìƒì„± ì¤‘... (30ì´ˆ~2ë¶„ ì†Œìš”)</span>';
  document.getElementById('aiout').textContent='ìƒì„± ì¤‘...';
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'x-api-key':key,'anthropic-version':'2023-06-01','content-type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4',max_tokens:4000,messages:[{role:'user',content:prompt}]})
    });
    const data=await res.json();
    if(data.content?.[0]?.text){
      document.getElementById('aiout').textContent=data.content[0].text;
      document.getElementById('ai-status').innerHTML='<span style="color:var(--green);">âœ… ìƒì„± ì™„ë£Œ</span>';
      D.aiPipelineLog.push({date:new Date().toISOString(),module:document.getElementById('aimod').value,status:'generated'});save();
    }else{
      document.getElementById('aiout').textContent='ì˜¤ë¥˜: '+JSON.stringify(data);
      document.getElementById('ai-status').innerHTML='<span style="color:var(--red);">âŒ ì˜¤ë¥˜</span>';
    }
  }catch(e){
    document.getElementById('aiout').textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: '+e.message;
    document.getElementById('ai-status').innerHTML='<span style="color:var(--red);">âŒ '+e.message+'</span>';
  }
}

function verifyAI(){const t=document.getElementById('aiout').textContent;if(t&&t!=='AI ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.'){alert('âœ… ê²€ì¦ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');D.aiPipelineLog.push({date:new Date().toISOString(),status:'verified'});save();}}
function copyAI(){navigator.clipboard.writeText(document.getElementById('aiout').textContent).then(()=>alert('âœ… ë³µì‚¬'));}
function saveAItoModule(){alert('AI ê²°ê³¼ë¥¼ í™•ì¸í•œ ë’¤, ë°ì´í„° ë§¤ë‹ˆì €ì—ì„œ í•´ë‹¹ ì‘í’ˆì˜ ê° í•„ë“œì— ì§ì ‘ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.\n\n(ì‘í’ˆ ì„ íƒ â†’ ê° í•„ë“œì— í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° â†’ ì €ì¥)');}

/* â•â•â•â•â•â• REHEARSAL TIMER â•â•â•â•â•â• */
function renderRhList(){
  const l=document.getElementById('rh-list');if(!rhSections.length){l.innerHTML='<p style="color:var(--t3);font-size:.8rem;">ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”</p>';return;}
  l.innerHTML=rhSections.map((s,i)=>`<div class="rh-section${i===rhCur?' active':''}" id="rhs-${i}"><span>${s.name}</span><span style="color:var(--gold);font-size:.72rem;">${s.min}ë¶„</span></div>`).join('');
  document.getElementById('rh-sec-name').textContent=rhSections[rhCur]?.name||'';
}
function rhStart(){if(!rhSections.length)return;rhPaused=false;if(!rhTimer)rhTimer=setInterval(()=>{if(rhPaused)return;rhSec++;const m=Math.floor(rhSec/60),s=rhSec%60;document.getElementById('rh-time').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;const lim=rhSections[rhCur]?.min*60;if(lim&&rhSec>=lim)document.getElementById('rh-time').style.color='var(--red)';},1000);}
function rhPause(){rhPaused=true;}
function rhNext(){if(rhCur<rhSections.length-1){document.getElementById(`rhs-${rhCur}`)?.classList.add('done');document.getElementById(`rhs-${rhCur}`)?.classList.remove('active');rhCur++;rhSec=0;document.getElementById('rh-time').style.color='var(--gold)';document.getElementById(`rhs-${rhCur}`)?.classList.add('active');document.getElementById('rh-sec-name').textContent=rhSections[rhCur]?.name||'';}}
function rhReset(){clearInterval(rhTimer);rhTimer=null;rhSec=0;rhPaused=true;rhCur=0;document.getElementById('rh-time').textContent='00:00';document.getElementById('rh-time').style.color='var(--gold)';renderRhList();}
/* â•â•â•â•â•â• SCRIPT MANAGER â•â•â•â•â•â• */
function showScriptManager(){
  const list = D.generatedScripts || [];
  if(!list.length){
    alert('ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  let h = `<div style="margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;">
    <h3 style="font-family:var(--serif);">ğŸ“‹ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡ (${list.length}ê°œ)</h3>
    <button class="btn btn-r" onclick="deleteAllScripts()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
  </div>`;
  list.forEach((s, i) => {
    const date = s.date ? new Date(s.date).toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
    h += `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;margin-bottom:6px;background:var(--bg0);border:1px solid var(--bd);border-radius:8px;">
      <div>
        <div style="font-size:.82rem;font-weight:600;">${s.module || 'ëª¨ë“ˆ ì—†ìŒ'}</div>
        <div style="font-size:.68rem;color:var(--t3);">${date} Â· ${s.type || ''} Â· ${s.duration || '?'}ë¶„</div>
      </div>
      <button class="btn btn-r" onclick="deleteScript(${i})" style="padding:4px 10px;font-size:.68rem;">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>`;
  });
  document.getElementById('editor').innerHTML = h;
}

function deleteScript(index){
  if(!confirm('ì´ ìŠ¤í¬ë¦½íŠ¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  D.generatedScripts.splice(index, 1);
  save(); renderTree();
  showScriptManager();
}

function deleteAllScripts(){
  if(!confirm('ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  D.generatedScripts = [];
  lastScript = null;
  save(); renderTree();
  document.getElementById('editor').innerHTML = '<p style="color:var(--t3);text-align:center;padding:40px;">âœ… ì „ì²´ ì‚­ì œ ì™„ë£Œ</p>';
}

/* â•â•â•â•â•â• EXPORT â•â•â•â•â•â• */
function expTxt(){if(!lastScript){alert('ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”');return;}const b=new Blob([lastScript],{type:'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`ë„ìŠ¨íŠ¸_ìŠ¤í¬ë¦½íŠ¸_${D.lastUpdated}.txt`;a.click();URL.revokeObjectURL(u);}
function expClip(){if(!lastScript){alert('ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”');return;}navigator.clipboard.writeText(lastScript).then(()=>alert('âœ… í´ë¦½ë³´ë“œ ë³µì‚¬'));}

/* â•â•â•â•â•â• INIT â•â•â•â•â•â• */
load();stats();renderTree();fillSelects();
</script>
</body>
</html>
